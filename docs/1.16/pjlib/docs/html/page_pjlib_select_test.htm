<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PJLIB Reference: Test: Socket Select() (1.16)</title>
<link href="/style/style.css" rel="stylesheet" type="text/css">
</head><body>
	<!--#include virtual="/header.html" -->
	<p><A HREF="/">Home</A> --&gt; <A HREF="/docs.htm">Documentations</A> --&gt; PJLIB Reference</p>


<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.htm"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.htm"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.htm"><span>Modules</span></a></li>
      <li><a href="annotated.htm"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.htm"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Test: Socket Select() </h1>  </div>
</div>
<div class="contents">
<p>This file provides implementation of <b>select_test()</b>. It tests the functionality of the <a class="el" href="group__PJ__SOCK__SELECT.htm#gac84492169bc8b8fbab6e48f1b9150b2f">pj_sock_select()</a> API.</p>
<p>This file is <b>pjlib-test/select.c</b></p>
<div class="fragment"><pre class="fragment"><span class="comment">/* $Id: select.c 3553 2011-05-05 06:14:19Z nanang $ */</span>
<span class="comment">/* </span>
<span class="comment"> * Copyright (C) 2008-2011 Teluu Inc. (http://www.teluu.com)</span>
<span class="comment"> * Copyright (C) 2003-2008 Benny Prijono &lt;benny@prijono.org&gt;</span>
<span class="comment"> *</span>
<span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="comment"> * (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment"> * GNU General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU General Public License</span>
<span class="comment"> * along with this program; if not, write to the Free Software</span>
<span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA </span>
<span class="comment"> */</span>
<span class="preprocessor">#include &quot;test.h&quot;</span>

<span class="preprocessor">#if INCLUDE_SELECT_TEST</span>
<span class="preprocessor"></span>
<span class="preprocessor">#include &lt;<a class="code" href="sock_8h.htm" title="Socket Abstraction.">pj/sock.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sock__select_8h.htm" title="Socket select().">pj/sock_select.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="log_8h.htm" title="Logging Utility.">pj/log.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="string_8h.htm" title="PJLIB String Operations.">pj/string.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="assert_8h.htm" title="Assertion macro pj_assert().">pj/assert.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="os_8h.htm" title="OS dependent functions.">pj/os.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="errno_8h.htm" title="PJLIB Error Subsystem.">pj/errno.h</a>&gt;</span>

<span class="keyword">enum</span>
{
    READ_FDS,
    WRITE_FDS,
    EXCEPT_FDS
};

<span class="preprocessor">#define UDP_PORT    51232</span>
<span class="preprocessor"></span><span class="preprocessor">#define THIS_FILE   &quot;select_test&quot;</span>
<span class="preprocessor"></span>
<span class="comment">/*</span>
<span class="comment"> * do_select()</span>
<span class="comment"> *</span>
<span class="comment"> * Perform pj_sock_select() and find out which sockets</span>
<span class="comment"> * are signalled.</span>
<span class="comment"> */</span>    
<span class="keyword">static</span> <span class="keywordtype">int</span> do_select( <a class="code" href="group__PJ__BASIC.htm#ga5ccc87de27d1236bc31ae3673d153984">pj_sock_t</a> sock1, <a class="code" href="group__PJ__BASIC.htm#ga5ccc87de27d1236bc31ae3673d153984">pj_sock_t</a> sock2,
                      <span class="keywordtype">int</span> setcount[])
{
    <a class="code" href="structpj__fd__set__t.htm">pj_fd_set_t</a> fds[3];
    <a class="code" href="structpj__time__val.htm">pj_time_val</a> timeout;
    <span class="keywordtype">int</span> i, n;
    
    <span class="keywordflow">for</span> (i=0; i&lt;3; ++i) {
        <a class="code" href="group__PJ__SOCK__SELECT.htm#ga73e77bf9c12e925d43e7b45f1121e596">PJ_FD_ZERO</a>(&amp;fds[i]);
        <a class="code" href="group__PJ__SOCK__SELECT.htm#ga5c61d47831851a00aed2361f0166bb69">PJ_FD_SET</a>(sock1, &amp;fds[i]);
        <a class="code" href="group__PJ__SOCK__SELECT.htm#ga5c61d47831851a00aed2361f0166bb69">PJ_FD_SET</a>(sock2, &amp;fds[i]);
        setcount[i] = 0;
    }

    timeout.<a class="code" href="structpj__time__val.htm#af2739d0c2189e9c902281c04fd1f4502">sec</a> = 1;
    timeout.<a class="code" href="structpj__time__val.htm#ab9cc04663b258dd3dcb449a3110e0d82">msec</a> = 0;

    n = <a class="code" href="group__PJ__SOCK__SELECT.htm#gac84492169bc8b8fbab6e48f1b9150b2f">pj_sock_select</a>(<a class="code" href="group__pj__config.htm#ga0b0fdd6e70bdbe412c1a3337ce3ff5ee">PJ_IOQUEUE_MAX_HANDLES</a>, &amp;fds[0], &amp;fds[1], &amp;fds[2],
                       &amp;timeout);
    <span class="keywordflow">if</span> (n &lt; 0)
        <span class="keywordflow">return</span> n;
    <span class="keywordflow">if</span> (n == 0)
        <span class="keywordflow">return</span> 0;

    <span class="keywordflow">for</span> (i=0; i&lt;3; ++i) {
        <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK__SELECT.htm#gab8396be2fb425e96a4182f7c90504477">PJ_FD_ISSET</a>(sock1, &amp;fds[i]))
            setcount[i]++;
        <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK__SELECT.htm#gab8396be2fb425e96a4182f7c90504477">PJ_FD_ISSET</a>(sock2, &amp;fds[i]))
            setcount[i]++;
    }

    <span class="keywordflow">return</span> n;
}

<span class="comment">/*</span>
<span class="comment"> * select_test()</span>
<span class="comment"> *</span>
<span class="comment"> * Test main entry.</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> select_test()
{
    <a class="code" href="group__PJ__BASIC.htm#ga5ccc87de27d1236bc31ae3673d153984">pj_sock_t</a> udp1=PJ_INVALID_SOCKET, udp2=PJ_INVALID_SOCKET;
    <a class="code" href="structpj__sockaddr__in.htm">pj_sockaddr_in</a> udp_addr;
    <span class="keywordtype">int</span> status;
    <span class="keywordtype">int</span> setcount[3];
    <a class="code" href="structpj__str__t.htm">pj_str_t</a> s;
    <span class="keyword">const</span> <span class="keywordtype">char</span> data[] = <span class="stringliteral">&quot;hello&quot;</span>;
    <span class="keyword">const</span> <span class="keywordtype">int</span> datalen = 5;
    <a class="code" href="group__PJ__BASIC.htm#ga173588cd6381f3ad354c23c26929093a">pj_ssize_t</a> sent, received;
    <span class="keywordtype">char</span> buf[10];
    <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> rc;

    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3, (THIS_FILE, <span class="stringliteral">&quot;...Testing simple UDP select()&quot;</span>));
    
    <span class="comment">// Create two UDP sockets.</span>
    rc = <a class="code" href="group__PJ__SOCK.htm#gaeec96c063aafa1d7c19b33590997bcff">pj_sock_socket</a>( <a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>(), <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), 0, &amp;udp1);
    <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
        app_perror(<span class="stringliteral">&quot;...error: unable to create socket&quot;</span>, rc);
        status=-10; <span class="keywordflow">goto</span> on_return;
    }
    rc = <a class="code" href="group__PJ__SOCK.htm#gaeec96c063aafa1d7c19b33590997bcff">pj_sock_socket</a>( <a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>(), <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), 0, &amp;udp2);
    <span class="keywordflow">if</span> (udp2 == <a class="code" href="group__PJ__SOCK.htm#gab44152e660cc3fd044afd590eeea78bc">PJ_INVALID_SOCKET</a>) {
        app_perror(<span class="stringliteral">&quot;...error: unable to create socket&quot;</span>, rc);
        status=-20; <span class="keywordflow">goto</span> on_return;
    }

    <span class="comment">// Bind one of the UDP socket.</span>
    <a class="code" href="group__PJ__PSTR.htm#gafa92001573289c87313c660146369fa3">pj_bzero</a>(&amp;udp_addr, <span class="keyword">sizeof</span>(udp_addr));
    udp_addr.<a class="code" href="structpj__sockaddr__in.htm#ab298fd61a3f2bf3036fe414740a53cc6">sin_family</a> = <a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>();
    udp_addr.<a class="code" href="structpj__sockaddr__in.htm#a0e60b93d03fa052211bb6131e64bdda1">sin_port</a> = UDP_PORT;
    udp_addr.<a class="code" href="structpj__sockaddr__in.htm#ad1ed5a34d99da0d23e65b3b3b5fad228">sin_addr</a> = <a class="code" href="group__PJ__SOCK.htm#gabcef38a6393a6c8e398b7e3ee2dac7d1">pj_inet_addr</a>(<a class="code" href="group__PJ__PSTR.htm#ga5a57d48a802ff650d8e5186cf65b7c4a">pj_cstr</a>(&amp;s, <span class="stringliteral">&quot;127.0.0.1&quot;</span>));

    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga173d6da92ef0a4f0df062bf377b4d626">pj_sock_bind</a>(udp2, &amp;udp_addr, <span class="keyword">sizeof</span>(udp_addr))) {
        status=-30; <span class="keywordflow">goto</span> on_return;
    }

    <span class="comment">// Send data.</span>
    sent = datalen;
    rc = <a class="code" href="group__PJ__SOCK.htm#ga9a84c286a4b7061503628b02d62f249a">pj_sock_sendto</a>(udp1, data, &amp;sent, 0, &amp;udp_addr, <span class="keyword">sizeof</span>(udp_addr));
    <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a> || sent != datalen) {
        app_perror(<span class="stringliteral">&quot;...error: sendto() error&quot;</span>, rc);
        status=-40; <span class="keywordflow">goto</span> on_return;
    }

    <span class="comment">// Sleep a bit. See http://trac.pjsip.org/repos/ticket/890</span>
    <a class="code" href="group__PJ__THREAD.htm#gad59cd6fd7390711758afcc0bde375d68">pj_thread_sleep</a>(10);

    <span class="comment">// Check that socket is marked as reable.</span>
    <span class="comment">// Note that select() may also report that sockets are writable.</span>
    status = do_select(udp1, udp2, setcount);
    <span class="keywordflow">if</span> (status &lt; 0) {
        <span class="keywordtype">char</span> errbuf[128];
        <a class="code" href="group__pj__errno.htm#ga7d2616aded0d61924fb31f4fd6ee45c0">pj_strerror</a>(<a class="code" href="group__pj__errno.htm#gaf32783cbca43d14cfc7e29694ba9057c">pj_get_netos_error</a>(), errbuf, <span class="keyword">sizeof</span>(errbuf));
        <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(1,(THIS_FILE, <span class="stringliteral">&quot;...error: %s&quot;</span>, errbuf));
        status=-50; <span class="keywordflow">goto</span> on_return;
    }
    <span class="keywordflow">if</span> (status == 0) {
        status=-60; <span class="keywordflow">goto</span> on_return;
    }

    <span class="keywordflow">if</span> (setcount[READ_FDS] != 1) {
        status=-70; <span class="keywordflow">goto</span> on_return;
    }
    <span class="keywordflow">if</span> (setcount[WRITE_FDS] != 0) {
        <span class="keywordflow">if</span> (setcount[WRITE_FDS] == 2) {
            <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;...info: system reports writable sockets&quot;</span>));
        } <span class="keywordflow">else</span> {
            status=-80; <span class="keywordflow">goto</span> on_return;
        }
    } <span class="keywordflow">else</span> {
        <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, 
                  <span class="stringliteral">&quot;...info: system doesn&#39;t report writable sockets&quot;</span>));
    }
    <span class="keywordflow">if</span> (setcount[EXCEPT_FDS] != 0) {
        status=-90; <span class="keywordflow">goto</span> on_return;
    }

    <span class="comment">// Read the socket to clear readable sockets.</span>
    received = <span class="keyword">sizeof</span>(buf);
    rc = <a class="code" href="group__PJ__SOCK.htm#gaef84c78edb396f0e1522117c48bce530">pj_sock_recv</a>(udp2, buf, &amp;received, 0);
    <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a> || received != 5) {
        status=-100; <span class="keywordflow">goto</span> on_return;
    }
    
    status = 0;

    <span class="comment">// Test timeout on the read part.</span>
    <span class="comment">// This won&#39;t necessarily return zero, as select() may report that</span>
    <span class="comment">// sockets are writable.</span>
    setcount[0] = setcount[1] = setcount[2] = 0;
    status = do_select(udp1, udp2, setcount);
    <span class="keywordflow">if</span> (status != 0 &amp;&amp; status != setcount[WRITE_FDS]) {
        <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;...error: expecting timeout but got %d sks set&quot;</span>,
                             status));
        <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;          rdset: %d, wrset: %d, exset: %d&quot;</span>,
                             setcount[0], setcount[1], setcount[2]));
        status = -110; <span class="keywordflow">goto</span> on_return;
    }
    <span class="keywordflow">if</span> (setcount[READ_FDS] != 0) {
        <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;...error: readable socket not expected&quot;</span>));
        status = -120; <span class="keywordflow">goto</span> on_return;
    }

    status = 0;

on_return:
    <span class="keywordflow">if</span> (udp1 != <a class="code" href="group__PJ__SOCK.htm#gab44152e660cc3fd044afd590eeea78bc">PJ_INVALID_SOCKET</a>)
        <a class="code" href="group__PJ__SOCK.htm#ga2f8faea76a64620b13a720227df927bb">pj_sock_close</a>(udp1);
    <span class="keywordflow">if</span> (udp2 != <a class="code" href="group__PJ__SOCK.htm#gab44152e660cc3fd044afd590eeea78bc">PJ_INVALID_SOCKET</a>)
        <a class="code" href="group__PJ__SOCK.htm#ga2f8faea76a64620b13a720227df927bb">pj_sock_close</a>(udp2);
    <span class="keywordflow">return</span> status;
}

<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="comment">/* To prevent warning about &quot;translation unit is empty&quot;</span>
<span class="comment"> * when this test is disabled. </span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> dummy_select_test;
<span class="preprocessor">#endif  </span><span class="comment">/* INCLUDE_SELECT_TEST */</span>


</pre></div> </div>
<p>&nbsp;</p>
<hr><center>
PJLIB Open Source, high performance, small footprint, and very very portable framework<br>
Copyright (C) 2006-2009 Teluu Inc.
</center>


<!--#include virtual="/footer.html" -->

</BODY>
</HTML>
