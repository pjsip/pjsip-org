<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PJLIB Reference: Test: I/O Queue Performance (1.16)</title>
<link href="/style/style.css" rel="stylesheet" type="text/css">
</head><body>
	<!--#include virtual="/header.html" -->
	<p><A HREF="/">Home</A> --&gt; <A HREF="/docs.htm">Documentations</A> --&gt; PJLIB Reference</p>


<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.htm"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.htm"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.htm"><span>Modules</span></a></li>
      <li><a href="annotated.htm"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.htm"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Test: I/O Queue Performance </h1>  </div>
</div>
<div class="contents">
<p>Test the performance of the I/O queue, using typical producer consumer test. The test should examine the effect of using multiple threads on the performance.</p>
<p>This file is <b>pjlib-test/ioq_perf.c</b></p>
<div class="fragment"><pre class="fragment"><span class="comment">/* $Id: ioq_perf.c 3553 2011-05-05 06:14:19Z nanang $ */</span>
<span class="comment">/* </span>
<span class="comment"> * Copyright (C) 2008-2011 Teluu Inc. (http://www.teluu.com)</span>
<span class="comment"> * Copyright (C) 2003-2008 Benny Prijono &lt;benny@prijono.org&gt;</span>
<span class="comment"> *</span>
<span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="comment"> * (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment"> * GNU General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU General Public License</span>
<span class="comment"> * along with this program; if not, write to the Free Software</span>
<span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA </span>
<span class="comment"> */</span>
<span class="preprocessor">#include &quot;test.h&quot;</span>
<span class="preprocessor">#include &lt;pjlib.h&gt;</span>
<span class="preprocessor">#include &lt;pj/compat/high_precision.h&gt;</span>

<span class="preprocessor">#if INCLUDE_IOQUEUE_PERF_TEST</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef _MSC_VER</span>
<span class="preprocessor"></span><span class="preprocessor">#   pragma warning ( disable: 4204)     // non-constant aggregate initializer</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define THIS_FILE       &quot;ioq_perf&quot;</span>
<span class="preprocessor"></span><span class="comment">//#define TRACE_(expr)  PJ_LOG(3,expr)</span>
<span class="preprocessor">#define TRACE_(expr)</span>
<span class="preprocessor"></span>

<span class="keyword">static</span> <a class="code" href="group__PJ__BASIC.htm#ga1dc7a356fb36bd2dee2bc7d6c7e817e4">pj_bool_t</a> thread_quit_flag;
<span class="keyword">static</span> <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> last_error;
<span class="keyword">static</span> <span class="keywordtype">unsigned</span> last_error_counter;

<span class="comment">/* Descriptor for each producer/consumer pair. */</span>
<span class="keyword">typedef</span> <span class="keyword">struct </span>test_item
{
    <a class="code" href="group__PJ__BASIC.htm#ga5ccc87de27d1236bc31ae3673d153984">pj_sock_t</a>            server_fd, 
                         client_fd;
    <a class="code" href="group__PJ__BASIC.htm#ga26ca218655d86b00d807e1407854128e">pj_ioqueue_t</a>        *ioqueue;
    <a class="code" href="group__PJ__BASIC.htm#ga89da69533fa1109f3a11ef91c489d9ad">pj_ioqueue_key_t</a>    *server_key,
                        *client_key;
    <a class="code" href="structpj__ioqueue__op__key__t.htm">pj_ioqueue_op_key_t</a>  recv_op,
                         send_op;
    <span class="keywordtype">int</span>                  has_pending_send;
    <a class="code" href="group__PJ__BASIC.htm#ga9fdb3ceb491cd888cd30ca30d78026e8">pj_size_t</a>            buffer_size;
    <span class="keywordtype">char</span>                *outgoing_buffer;
    <span class="keywordtype">char</span>                *incoming_buffer;
    <a class="code" href="group__PJ__BASIC.htm#ga9fdb3ceb491cd888cd30ca30d78026e8">pj_size_t</a>            bytes_sent, 
                         bytes_recv;
} test_item;

<span class="comment">/* Callback when data has been read.</span>
<span class="comment"> * Increment item-&gt;bytes_recv and ready to read the next data.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> on_read_complete(<a class="code" href="group__PJ__BASIC.htm#ga89da69533fa1109f3a11ef91c489d9ad">pj_ioqueue_key_t</a> *key, 
                             <a class="code" href="structpj__ioqueue__op__key__t.htm">pj_ioqueue_op_key_t</a> *op_key,
                             <a class="code" href="group__PJ__BASIC.htm#ga173588cd6381f3ad354c23c26929093a">pj_ssize_t</a> bytes_read)
{
    test_item *item = (test_item*)<a class="code" href="group__PJ__IOQUEUE.htm#ga238dc908101226262f8ba91393e12efc">pj_ioqueue_get_user_data</a>(key);
    <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> rc;
    <span class="keywordtype">int</span> data_is_available = 1;

    <span class="comment">//TRACE_((THIS_FILE, &quot;     read complete, bytes_read=%d&quot;, bytes_read));</span>

    <span class="keywordflow">do</span> {
        <span class="keywordflow">if</span> (thread_quit_flag)
            <span class="keywordflow">return</span>;

        <span class="keywordflow">if</span> (bytes_read &lt; 0) {
            <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> rc = -bytes_read;
            <span class="keywordtype">char</span> errmsg[PJ_ERR_MSG_SIZE];

            <span class="keywordflow">if</span> (rc != last_error) {
                <span class="comment">//last_error = rc;</span>
                <a class="code" href="group__pj__errno.htm#ga7d2616aded0d61924fb31f4fd6ee45c0">pj_strerror</a>(rc, errmsg, <span class="keyword">sizeof</span>(errmsg));
                <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE,<span class="stringliteral">&quot;...error: read error, bytes_read=%d (%s)&quot;</span>, 
                          bytes_read, errmsg));
                <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, 
                          <span class="stringliteral">&quot;.....additional info: total read=%u, total sent=%u&quot;</span>,
                          item-&gt;bytes_recv, item-&gt;bytes_sent));
            } <span class="keywordflow">else</span> {
                last_error_counter++;
            }
            bytes_read = 0;

        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bytes_read == 0) {
            <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;...socket has closed!&quot;</span>));
        }

        item-&gt;bytes_recv += bytes_read;
    
        <span class="comment">/* To assure that the test quits, even if main thread</span>
<span class="comment">         * doesn&#39;t have time to run.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (item-&gt;bytes_recv &gt; item-&gt;buffer_size * 10000) 
            thread_quit_flag = 1;

        bytes_read = item-&gt;buffer_size;
        rc = <a class="code" href="group__PJ__IOQUEUE.htm#ga71e08c6414a6f0cd1c1d2fde267bccbe">pj_ioqueue_recv</a>( key, op_key,
                              item-&gt;incoming_buffer, &amp;bytes_read, 0 );

        <span class="keywordflow">if</span> (rc == <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            data_is_available = 1;
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="group__pj__errnum.htm#ga8706796879339b5dc875e2af631d6fe7">PJ_EPENDING</a>) {
            data_is_available = 0;
        } <span class="keywordflow">else</span> {
            data_is_available = 0;
            <span class="keywordflow">if</span> (rc != last_error) {
                last_error = rc;
                app_perror(<span class="stringliteral">&quot;...error: read error(1)&quot;</span>, rc);
            } <span class="keywordflow">else</span> {
                last_error_counter++;
            }
        }

        <span class="keywordflow">if</span> (!item-&gt;has_pending_send) {
            <a class="code" href="group__PJ__BASIC.htm#ga173588cd6381f3ad354c23c26929093a">pj_ssize_t</a> sent = item-&gt;buffer_size;
            rc = <a class="code" href="group__PJ__IOQUEUE.htm#gabf96d153949aeda0e7b9dbb742ffcda7">pj_ioqueue_send</a>(item-&gt;client_key, &amp;item-&gt;send_op,
                                 item-&gt;outgoing_buffer, &amp;sent, 0);
            <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="group__pj__errnum.htm#ga8706796879339b5dc875e2af631d6fe7">PJ_EPENDING</a>) {
                app_perror(<span class="stringliteral">&quot;...error: write error&quot;</span>, rc);
            }

            item-&gt;has_pending_send = (rc==PJ_EPENDING);
        }

    } <span class="keywordflow">while</span> (data_is_available);
}

<span class="comment">/* Callback when data has been written.</span>
<span class="comment"> * Increment item-&gt;bytes_sent and write the next data.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> on_write_complete(<a class="code" href="group__PJ__BASIC.htm#ga89da69533fa1109f3a11ef91c489d9ad">pj_ioqueue_key_t</a> *key, 
                              <a class="code" href="structpj__ioqueue__op__key__t.htm">pj_ioqueue_op_key_t</a> *op_key,
                              <a class="code" href="group__PJ__BASIC.htm#ga173588cd6381f3ad354c23c26929093a">pj_ssize_t</a> bytes_sent)
{
    test_item *item = (test_item*) <a class="code" href="group__PJ__IOQUEUE.htm#ga238dc908101226262f8ba91393e12efc">pj_ioqueue_get_user_data</a>(key);
    
    <span class="comment">//TRACE_((THIS_FILE, &quot;     write complete: sent = %d&quot;, bytes_sent));</span>

    <span class="keywordflow">if</span> (thread_quit_flag)
        <span class="keywordflow">return</span>;

    item-&gt;has_pending_send = 0;
    item-&gt;bytes_sent += bytes_sent;

    <span class="keywordflow">if</span> (bytes_sent &lt;= 0) {
        <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;...error: sending stopped. bytes_sent=%d&quot;</span>, 
                  bytes_sent));
    } 
    <span class="keywordflow">else</span> {
        <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> rc;

        bytes_sent = item-&gt;buffer_size;
        rc = <a class="code" href="group__PJ__IOQUEUE.htm#gabf96d153949aeda0e7b9dbb742ffcda7">pj_ioqueue_send</a>( item-&gt;client_key, op_key,
                              item-&gt;outgoing_buffer, &amp;bytes_sent, 0);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="group__pj__errnum.htm#ga8706796879339b5dc875e2af631d6fe7">PJ_EPENDING</a>) {
            app_perror(<span class="stringliteral">&quot;...error: write error&quot;</span>, rc);
        }

        item-&gt;has_pending_send = (rc==PJ_EPENDING);
    }
}

<span class="keyword">struct </span>thread_arg
{
    <span class="keywordtype">int</span>           id;
    <a class="code" href="group__PJ__BASIC.htm#ga26ca218655d86b00d807e1407854128e">pj_ioqueue_t</a> *ioqueue;
    <span class="keywordtype">unsigned</span>      counter;
};

<span class="comment">/* The worker thread. */</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> worker_thread(<span class="keywordtype">void</span> *p)
{
    <span class="keyword">struct </span>thread_arg *arg = (<span class="keyword">struct </span>thread_arg*) p;
    <span class="keyword">const</span> <a class="code" href="structpj__time__val.htm">pj_time_val</a> timeout = {0, 100};
    <span class="keywordtype">int</span> rc;

    <span class="keywordflow">while</span> (!thread_quit_flag) {

        ++arg-&gt;counter;
        rc = <a class="code" href="group__PJ__IOQUEUE.htm#gac65cc5cb9a04f2008d1fa62709ba2d91">pj_ioqueue_poll</a>(arg-&gt;ioqueue, &amp;timeout);
        <span class="comment">//TRACE_((THIS_FILE, &quot;     thread: poll returned rc=%d&quot;, rc));</span>
        <span class="keywordflow">if</span> (rc &lt; 0) {
            <span class="keywordtype">char</span> errmsg[PJ_ERR_MSG_SIZE];
            <a class="code" href="group__pj__errno.htm#ga7d2616aded0d61924fb31f4fd6ee45c0">pj_strerror</a>(-rc, errmsg, <span class="keyword">sizeof</span>(errmsg));
            <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3, (THIS_FILE, 
                       <span class="stringliteral">&quot;...error in pj_ioqueue_poll() in thread %d &quot;</span>
                       <span class="stringliteral">&quot;after %d loop: %s [pj_status_t=%d]&quot;</span>, 
                       arg-&gt;id, arg-&gt;counter, errmsg, -rc));
            <span class="comment">//return -1;</span>
        }
    }
    <span class="keywordflow">return</span> 0;
}

<span class="comment">/* Calculate the bandwidth for the specific test configuration.</span>
<span class="comment"> * The test is simple:</span>
<span class="comment"> *  - create sockpair_cnt number of producer-consumer socket pair.</span>
<span class="comment"> *  - create thread_cnt number of worker threads.</span>
<span class="comment"> *  - each producer will send buffer_size bytes data as fast and</span>
<span class="comment"> *    as soon as it can.</span>
<span class="comment"> *  - each consumer will read buffer_size bytes of data as fast </span>
<span class="comment"> *    as it could.</span>
<span class="comment"> *  - measure the total bytes received by all consumers during a</span>
<span class="comment"> *    period of time.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> perform_test(<a class="code" href="group__PJ__BASIC.htm#ga1dc7a356fb36bd2dee2bc7d6c7e817e4">pj_bool_t</a> allow_concur,
                        <span class="keywordtype">int</span> sock_type, <span class="keyword">const</span> <span class="keywordtype">char</span> *type_name,
                        <span class="keywordtype">unsigned</span> thread_cnt, <span class="keywordtype">unsigned</span> sockpair_cnt,
                        <a class="code" href="group__PJ__BASIC.htm#ga9fdb3ceb491cd888cd30ca30d78026e8">pj_size_t</a> buffer_size, 
                        <a class="code" href="group__PJ__BASIC.htm#ga9fdb3ceb491cd888cd30ca30d78026e8">pj_size_t</a> *p_bandwidth)
{
    <span class="keyword">enum</span> { MSEC_DURATION = 5000 };
    <a class="code" href="structpj__pool__t.htm">pj_pool_t</a> *pool;
    test_item *items;
    <a class="code" href="group__PJ__BASIC.htm#gacb9d46aed6813bf142efc1c3db7a2d17">pj_thread_t</a> **thread;
    <a class="code" href="group__PJ__BASIC.htm#ga26ca218655d86b00d807e1407854128e">pj_ioqueue_t</a> *ioqueue;
    <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> rc;
    <a class="code" href="structpj__ioqueue__callback.htm">pj_ioqueue_callback</a> ioqueue_callback;
    <a class="code" href="group__PJ__BASIC.htm#gafbfd2fd08c6041ea3cb217310c0b5b48">pj_uint32_t</a> total_elapsed_usec, total_received;
    pj_highprec_t bandwidth;
    <a class="code" href="unionpj__timestamp.htm">pj_timestamp</a> start, stop;
    <span class="keywordtype">unsigned</span> i;

    TRACE_((THIS_FILE, <span class="stringliteral">&quot;    starting test..&quot;</span>));

    ioqueue_callback.<a class="code" href="structpj__ioqueue__callback.htm#aef60532d102c3174555e61127cf9ec1b">on_read_complete</a> = &amp;on_read_complete;
    ioqueue_callback.<a class="code" href="group__PJ__IOQUEUE.htm#gad79249d319b012a8366921e277299dc7">on_write_complete</a> = &amp;on_write_complete;

    thread_quit_flag = 0;

    pool = <a class="code" href="group__PJ__POOL.htm#gaf58c3ba26a1314c0e0be103960ba4a5e">pj_pool_create</a>(mem, NULL, 4096, 4096, NULL);
    <span class="keywordflow">if</span> (!pool)
        <span class="keywordflow">return</span> -10;

    items = (test_item*) <a class="code" href="group__PJ__POOL.htm#ga865b3702766960869d1c58429e213cf4">pj_pool_alloc</a>(pool, sockpair_cnt*<span class="keyword">sizeof</span>(test_item));
    thread = (<a class="code" href="group__PJ__BASIC.htm#gacb9d46aed6813bf142efc1c3db7a2d17">pj_thread_t</a>**)
             <a class="code" href="group__PJ__POOL.htm#ga865b3702766960869d1c58429e213cf4">pj_pool_alloc</a>(pool, thread_cnt*<span class="keyword">sizeof</span>(<a class="code" href="group__PJ__BASIC.htm#gacb9d46aed6813bf142efc1c3db7a2d17">pj_thread_t</a>*));

    TRACE_((THIS_FILE, <span class="stringliteral">&quot;     creating ioqueue..&quot;</span>));
    rc = <a class="code" href="group__PJ__IOQUEUE.htm#gaae188673e57ae841d586a738e53cffc5">pj_ioqueue_create</a>(pool, sockpair_cnt*2, &amp;ioqueue);
    <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
        app_perror(<span class="stringliteral">&quot;...error: unable to create ioqueue&quot;</span>, rc);
        <span class="keywordflow">return</span> -15;
    }

    rc = <a class="code" href="group__PJ__IOQUEUE.htm#ga61f080c7c8d52bcf5e2d955257fde21e">pj_ioqueue_set_default_concurrency</a>(ioqueue, allow_concur);
    <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
        app_perror(<span class="stringliteral">&quot;...error: pj_ioqueue_set_default_concurrency()&quot;</span>, rc);
        <span class="keywordflow">return</span> -16;
    }

    <span class="comment">/* Initialize each producer-consumer pair. */</span>
    <span class="keywordflow">for</span> (i=0; i&lt;sockpair_cnt; ++i) {
        <a class="code" href="group__PJ__BASIC.htm#ga173588cd6381f3ad354c23c26929093a">pj_ssize_t</a> bytes;

        items[i].ioqueue = ioqueue;
        items[i].buffer_size = buffer_size;
        items[i].outgoing_buffer = (<span class="keywordtype">char</span>*) <a class="code" href="group__PJ__POOL.htm#ga865b3702766960869d1c58429e213cf4">pj_pool_alloc</a>(pool, buffer_size);
        items[i].incoming_buffer = (<span class="keywordtype">char</span>*) <a class="code" href="group__PJ__POOL.htm#ga865b3702766960869d1c58429e213cf4">pj_pool_alloc</a>(pool, buffer_size);
        items[i].bytes_recv = items[i].bytes_sent = 0;

        <span class="comment">/* randomize outgoing buffer. */</span>
        <a class="code" href="group__PJ__PSTR.htm#gae0f30eb53208168b12b6c8e50649ce89">pj_create_random_string</a>(items[i].outgoing_buffer, buffer_size);

        <span class="comment">/* Create socket pair. */</span>
        TRACE_((THIS_FILE, <span class="stringliteral">&quot;      calling socketpair..&quot;</span>));
        rc = app_socketpair(<a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>(), sock_type, 0, 
                            &amp;items[i].server_fd, &amp;items[i].client_fd);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            app_perror(<span class="stringliteral">&quot;...error: unable to create socket pair&quot;</span>, rc);
            <span class="keywordflow">return</span> -20;
        }

        <span class="comment">/* Register server socket to ioqueue. */</span>
        TRACE_((THIS_FILE, <span class="stringliteral">&quot;      register(1)..&quot;</span>));
        rc = <a class="code" href="group__PJ__IOQUEUE.htm#gada2faae3ca27a917b90f6fa39b758355">pj_ioqueue_register_sock</a>(pool, ioqueue, 
                                      items[i].server_fd,
                                      &amp;items[i], &amp;ioqueue_callback,
                                      &amp;items[i].server_key);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            app_perror(<span class="stringliteral">&quot;...error: registering server socket to ioqueue&quot;</span>, rc);
            <span class="keywordflow">return</span> -60;
        }

        <span class="comment">/* Register client socket to ioqueue. */</span>
        TRACE_((THIS_FILE, <span class="stringliteral">&quot;      register(2)..&quot;</span>));
        rc = <a class="code" href="group__PJ__IOQUEUE.htm#gada2faae3ca27a917b90f6fa39b758355">pj_ioqueue_register_sock</a>(pool, ioqueue, 
                                      items[i].client_fd,
                                      &amp;items[i],  &amp;ioqueue_callback,
                                      &amp;items[i].client_key);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            app_perror(<span class="stringliteral">&quot;...error: registering server socket to ioqueue&quot;</span>, rc);
            <span class="keywordflow">return</span> -70;
        }

        <span class="comment">/* Start reading. */</span>
        TRACE_((THIS_FILE, <span class="stringliteral">&quot;      pj_ioqueue_recv..&quot;</span>));
        bytes = items[i].buffer_size;
        rc = <a class="code" href="group__PJ__IOQUEUE.htm#ga71e08c6414a6f0cd1c1d2fde267bccbe">pj_ioqueue_recv</a>(items[i].server_key, &amp;items[i].recv_op,
                             items[i].incoming_buffer, &amp;bytes,
                             0);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__pj__errnum.htm#ga8706796879339b5dc875e2af631d6fe7">PJ_EPENDING</a>) {
            app_perror(<span class="stringliteral">&quot;...error: pj_ioqueue_recv&quot;</span>, rc);
            <span class="keywordflow">return</span> -73;
        }

        <span class="comment">/* Start writing. */</span>
        TRACE_((THIS_FILE, <span class="stringliteral">&quot;      pj_ioqueue_write..&quot;</span>));
        bytes = items[i].buffer_size;
        rc = <a class="code" href="group__PJ__IOQUEUE.htm#gabf96d153949aeda0e7b9dbb742ffcda7">pj_ioqueue_send</a>(items[i].client_key, &amp;items[i].send_op,
                             items[i].outgoing_buffer, &amp;bytes, 0);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a> &amp;&amp; rc != <a class="code" href="group__pj__errnum.htm#ga8706796879339b5dc875e2af631d6fe7">PJ_EPENDING</a>) {
            app_perror(<span class="stringliteral">&quot;...error: pj_ioqueue_write&quot;</span>, rc);
            <span class="keywordflow">return</span> -76;
        }

        items[i].has_pending_send = (rc==PJ_EPENDING);
    }

    <span class="comment">/* Create the threads. */</span>
    <span class="keywordflow">for</span> (i=0; i&lt;thread_cnt; ++i) {
        <span class="keyword">struct </span>thread_arg *arg;

        arg = (<span class="keyword">struct </span>thread_arg*) <a class="code" href="group__PJ__POOL.htm#ga4ecb4c956f18e49b20308ffd075b0b40">pj_pool_zalloc</a>(pool, <span class="keyword">sizeof</span>(*arg));
        arg-&gt;id = i;
        arg-&gt;ioqueue = ioqueue;
        arg-&gt;counter = 0;

        rc = <a class="code" href="group__PJ__THREAD.htm#ga7b63533cf4f3ba0cba68cab49a22d722">pj_thread_create</a>( pool, NULL, 
                               &amp;worker_thread, 
                               arg, 
                               <a class="code" href="group__pj__config.htm#gac2fba901c0f4a6af0a6cfc948a420602">PJ_THREAD_DEFAULT_STACK_SIZE</a>, 
                               PJ_THREAD_SUSPENDED, &amp;thread[i] );
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            app_perror(<span class="stringliteral">&quot;...error: unable to create thread&quot;</span>, rc);
            <span class="keywordflow">return</span> -80;
        }
    }

    <span class="comment">/* Mark start time. */</span>
    rc = <a class="code" href="group__PJ__TIMESTAMP.htm#gaa419b8448d1cb55db85aeac2e86fe11c">pj_get_timestamp</a>(&amp;start);
    <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>)
        <span class="keywordflow">return</span> -90;

    <span class="comment">/* Start the thread. */</span>
    TRACE_((THIS_FILE, <span class="stringliteral">&quot;     resuming all threads..&quot;</span>));
    <span class="keywordflow">for</span> (i=0; i&lt;thread_cnt; ++i) {
        rc = <a class="code" href="group__PJ__THREAD.htm#ga223e764be70bd61ab21a77c76be32783">pj_thread_resume</a>(thread[i]);
        <span class="keywordflow">if</span> (rc != 0)
            <span class="keywordflow">return</span> -100;
    }

    <span class="comment">/* Wait for MSEC_DURATION seconds. </span>
<span class="comment">     * This should be as simple as pj_thread_sleep(MSEC_DURATION) actually,</span>
<span class="comment">     * but unfortunately it doesn&#39;t work when system doesn&#39;t employ</span>
<span class="comment">     * timeslicing for threads.</span>
<span class="comment">     */</span>
    TRACE_((THIS_FILE, <span class="stringliteral">&quot;     wait for few seconds..&quot;</span>));
    <span class="keywordflow">do</span> {
        <a class="code" href="group__PJ__THREAD.htm#gad59cd6fd7390711758afcc0bde375d68">pj_thread_sleep</a>(1);

        <span class="comment">/* Mark end time. */</span>
        rc = <a class="code" href="group__PJ__TIMESTAMP.htm#gaa419b8448d1cb55db85aeac2e86fe11c">pj_get_timestamp</a>(&amp;stop);

        <span class="keywordflow">if</span> (thread_quit_flag) {
            TRACE_((THIS_FILE, <span class="stringliteral">&quot;      transfer limit reached..&quot;</span>));
            <span class="keywordflow">break</span>;
        }

        <span class="keywordflow">if</span> (<a class="code" href="group__PJ__TIMESTAMP.htm#gad5a0323beb04de52474b59693b4b12ac">pj_elapsed_usec</a>(&amp;start,&amp;stop)&lt;MSEC_DURATION * 1000) {
            TRACE_((THIS_FILE, <span class="stringliteral">&quot;      time limit reached..&quot;</span>));
            <span class="keywordflow">break</span>;
        }

    } <span class="keywordflow">while</span> (1);

    <span class="comment">/* Terminate all threads. */</span>
    TRACE_((THIS_FILE, <span class="stringliteral">&quot;     terminating all threads..&quot;</span>));
    thread_quit_flag = 1;

    <span class="keywordflow">for</span> (i=0; i&lt;thread_cnt; ++i) {
        TRACE_((THIS_FILE, <span class="stringliteral">&quot;      join thread %d..&quot;</span>, i));
        <a class="code" href="group__PJ__THREAD.htm#ga60d90ce08d2f7e92dcaa0443cf87912f">pj_thread_join</a>(thread[i]);
    }

    <span class="comment">/* Close all sockets. */</span>
    TRACE_((THIS_FILE, <span class="stringliteral">&quot;     closing all sockets..&quot;</span>));
    <span class="keywordflow">for</span> (i=0; i&lt;sockpair_cnt; ++i) {
        <a class="code" href="group__PJ__IOQUEUE.htm#ga7c05e3b02e71e7680679c90c2adbe230">pj_ioqueue_unregister</a>(items[i].server_key);
        <a class="code" href="group__PJ__IOQUEUE.htm#ga7c05e3b02e71e7680679c90c2adbe230">pj_ioqueue_unregister</a>(items[i].client_key);
    }

    <span class="comment">/* Destroy threads */</span>
    <span class="keywordflow">for</span> (i=0; i&lt;thread_cnt; ++i) {
        <a class="code" href="group__PJ__THREAD.htm#ga5435f79ad044f9ce2113af311bf2b777">pj_thread_destroy</a>(thread[i]);
    }

    <span class="comment">/* Destroy ioqueue. */</span>
    TRACE_((THIS_FILE, <span class="stringliteral">&quot;     destroying ioqueue..&quot;</span>));
    <a class="code" href="group__PJ__IOQUEUE.htm#ga59f004632b9ae20e43fa573e6b6cb237">pj_ioqueue_destroy</a>(ioqueue);

    <span class="comment">/* Calculate actual time in usec. */</span>
    total_elapsed_usec = <a class="code" href="group__PJ__TIMESTAMP.htm#gad5a0323beb04de52474b59693b4b12ac">pj_elapsed_usec</a>(&amp;start, &amp;stop);

    <span class="comment">/* Calculate total bytes received. */</span>
    total_received = 0;
    <span class="keywordflow">for</span> (i=0; i&lt;sockpair_cnt; ++i) {
        total_received = items[i].bytes_recv;
    }

    <span class="comment">/* bandwidth = total_received*1000/total_elapsed_usec */</span>
    bandwidth = total_received;
    pj_highprec_mul(bandwidth, 1000);
    pj_highprec_div(bandwidth, total_elapsed_usec);
    
    *p_bandwidth = (pj_uint32_t)bandwidth;

    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;   %.4s    %2d        %2d       %8d KB/s&quot;</span>,
              type_name, thread_cnt, sockpair_cnt,
              *p_bandwidth));

    <span class="comment">/* Done. */</span>
    <a class="code" href="group__PJ__POOL.htm#gade0f14f6635ecfccb576ec41c57fede5">pj_pool_release</a>(pool);

    TRACE_((THIS_FILE, <span class="stringliteral">&quot;    done..&quot;</span>));
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> ioqueue_perf_test_imp(<a class="code" href="group__PJ__BASIC.htm#ga1dc7a356fb36bd2dee2bc7d6c7e817e4">pj_bool_t</a> allow_concur)
{
    <span class="keyword">enum</span> { BUF_SIZE = 512 };
    <span class="keywordtype">int</span> i, rc;
    <span class="keyword">struct </span>{
        <span class="keywordtype">int</span>         type;
        <span class="keyword">const</span> <span class="keywordtype">char</span> *type_name;
        <span class="keywordtype">int</span>         thread_cnt;
        <span class="keywordtype">int</span>         sockpair_cnt;
    } test_param[] = 
    {
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 1, 1},
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 1, 2},
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 1, 4},
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 1, 8},
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 2, 1},
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 2, 2},
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 2, 4},
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 2, 8},
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 4, 1},
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 4, 2},
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 4, 4},
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 4, 8},
        { <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), <span class="stringliteral">&quot;udp&quot;</span>, 4, 16},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 1, 1},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 1, 2},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 1, 4},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 1, 8},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 2, 1},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 2, 2},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 2, 4},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 2, 8},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 4, 1},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 4, 2},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 4, 4},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 4, 8},
        { <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), <span class="stringliteral">&quot;tcp&quot;</span>, 4, 16},
<span class="comment">/*</span>
<span class="comment">        { pj_SOCK_DGRAM(), &quot;udp&quot;, 32, 1},</span>
<span class="comment">        { pj_SOCK_DGRAM(), &quot;udp&quot;, 32, 1},</span>
<span class="comment">        { pj_SOCK_DGRAM(), &quot;udp&quot;, 32, 1},</span>
<span class="comment">        { pj_SOCK_DGRAM(), &quot;udp&quot;, 32, 1},</span>
<span class="comment">        { pj_SOCK_DGRAM(), &quot;udp&quot;, 1, 32},</span>
<span class="comment">        { pj_SOCK_DGRAM(), &quot;udp&quot;, 1, 32},</span>
<span class="comment">        { pj_SOCK_DGRAM(), &quot;udp&quot;, 1, 32},</span>
<span class="comment">        { pj_SOCK_DGRAM(), &quot;udp&quot;, 1, 32},</span>
<span class="comment">        { pj_SOCK_STREAM(), &quot;tcp&quot;, 32, 1},</span>
<span class="comment">        { pj_SOCK_STREAM(), &quot;tcp&quot;, 32, 1},</span>
<span class="comment">        { pj_SOCK_STREAM(), &quot;tcp&quot;, 32, 1},</span>
<span class="comment">        { pj_SOCK_STREAM(), &quot;tcp&quot;, 32, 1},</span>
<span class="comment">        { pj_SOCK_STREAM(), &quot;tcp&quot;, 1, 32},</span>
<span class="comment">        { pj_SOCK_STREAM(), &quot;tcp&quot;, 1, 32},</span>
<span class="comment">        { pj_SOCK_STREAM(), &quot;tcp&quot;, 1, 32},</span>
<span class="comment">        { pj_SOCK_STREAM(), &quot;tcp&quot;, 1, 32},</span>
<span class="comment">*/</span>
    };
    <a class="code" href="group__PJ__BASIC.htm#ga9fdb3ceb491cd888cd30ca30d78026e8">pj_size_t</a> best_bandwidth;
    <span class="keywordtype">int</span> best_index = 0;

    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;   Benchmarking %s ioqueue:&quot;</span>, <a class="code" href="group__PJ__IOQUEUE.htm#ga6179808511eccf51f35944c4b7de679e">pj_ioqueue_name</a>()));
    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;   Testing with concurency=%d&quot;</span>, allow_concur));
    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;   =======================================&quot;</span>));
    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;   Type  Threads  Skt.Pairs      Bandwidth&quot;</span>));
    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;   =======================================&quot;</span>));

    best_bandwidth = 0;
    <span class="keywordflow">for</span> (i=0; i&lt;(int)(<span class="keyword">sizeof</span>(test_param)/<span class="keyword">sizeof</span>(test_param[0])); ++i) {
        <a class="code" href="group__PJ__BASIC.htm#ga9fdb3ceb491cd888cd30ca30d78026e8">pj_size_t</a> bandwidth;

        rc = perform_test(allow_concur,
                          test_param[i].type, 
                          test_param[i].type_name,
                          test_param[i].thread_cnt, 
                          test_param[i].sockpair_cnt, 
                          BUF_SIZE, 
                          &amp;bandwidth);
        <span class="keywordflow">if</span> (rc != 0)
            <span class="keywordflow">return</span> rc;

        <span class="keywordflow">if</span> (bandwidth &gt; best_bandwidth)
            best_bandwidth = bandwidth, best_index = i;

        <span class="comment">/* Give it a rest before next test, to allow system to close the</span>
<span class="comment">         * sockets properly. </span>
<span class="comment">         */</span>
        <a class="code" href="group__PJ__THREAD.htm#gad59cd6fd7390711758afcc0bde375d68">pj_thread_sleep</a>(500);
    }

    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, 
              <span class="stringliteral">&quot;   Best: Type=%s Threads=%d, Skt.Pairs=%d, Bandwidth=%u KB/s&quot;</span>,
              test_param[best_index].type_name,
              test_param[best_index].thread_cnt,
              test_param[best_index].sockpair_cnt,
              best_bandwidth));
    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(THIS_FILE, <span class="stringliteral">&quot;   (Note: packet size=%d, total errors=%u)&quot;</span>, 
                         BUF_SIZE, last_error_counter));
    <span class="keywordflow">return</span> 0;
}

<span class="comment">/*</span>
<span class="comment"> * main test entry.</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> ioqueue_perf_test(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> rc;

    rc = ioqueue_perf_test_imp(<a class="code" href="group__PJ__BASIC.htm#gac8d6a18466c2489aae935c44f15edb5b">PJ_TRUE</a>);
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">return</span> rc;

    rc = ioqueue_perf_test_imp(<a class="code" href="group__PJ__BASIC.htm#ga211deece8bfa6b5b508a4b1d172928f2">PJ_FALSE</a>);
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">return</span> rc;

    <span class="keywordflow">return</span> 0;
}

<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="comment">/* To prevent warning about &quot;translation unit is empty&quot;</span>
<span class="comment"> * when this test is disabled. </span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> dummy_uiq_perf_test;
<span class="preprocessor">#endif  </span><span class="comment">/* INCLUDE_IOQUEUE_PERF_TEST */</span>


</pre></div> </div>
<p>&nbsp;</p>
<hr><center>
PJLIB Open Source, high performance, small footprint, and very very portable framework<br>
Copyright (C) 2006-2009 Teluu Inc.
</center>


<!--#include virtual="/footer.html" -->

</BODY>
</HTML>
