<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PJLIB Reference: Test: Socket (1.16)</title>
<link href="/style/style.css" rel="stylesheet" type="text/css">
</head><body>
	<!--#include virtual="/header.html" -->
	<p><A HREF="/">Home</A> --&gt; <A HREF="/docs.htm">Documentations</A> --&gt; PJLIB Reference</p>


<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.htm"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.htm"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.htm"><span>Modules</span></a></li>
      <li><a href="annotated.htm"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.htm"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Test: Socket </h1>  </div>
</div>
<div class="contents">
<p>This file provides implementation of <b>sock_test()</b>. It tests the various aspects of the socket API.</p>
<h2><a class="anchor" id="sock_test_scope_sec"></a>
Scope of the Test</h2>
<p>The scope of the test:</p>
<ul>
<li>verify the validity of the address structs.</li>
<li>verify that address manipulation API works.</li>
<li>simple socket creation and destruction.</li>
<li>simple socket send/recv and sendto/recvfrom.</li>
<li>UDP connect()</li>
<li>send/recv big data.</li>
<li>all for both UDP and TCP.</li>
</ul>
<p>The APIs tested in this test:</p>
<ul>
<li><a class="el" href="group__PJ__SOCK.htm#ga6f10f1bd1d75f2036b90f561df7eabd1">pj_inet_aton()</a></li>
<li><a class="el" href="group__PJ__SOCK.htm#ga399118ab0e5fea21ba5599caa260bc20">pj_inet_ntoa()</a></li>
<li><a class="el" href="group__PJ__SOCK.htm#ga8fdeab44dae09560b1f87cf6570c97e5">pj_inet_pton()</a> (only if IPv6 is enabled)</li>
<li><a class="el" href="group__PJ__SOCK.htm#ga506ba0f8230021a6cdd1bdab22c32e2e">pj_inet_ntop()</a> (only if IPv6 is enabled)</li>
<li><a class="el" href="group__PJ__SOCK.htm#ga47bc19975b9e88fc86d4bf43ffd2a17f">pj_gethostname()</a></li>
<li><a class="el" href="group__PJ__SOCK.htm#gaeec96c063aafa1d7c19b33590997bcff">pj_sock_socket()</a></li>
<li><a class="el" href="group__PJ__SOCK.htm#ga2f8faea76a64620b13a720227df927bb">pj_sock_close()</a></li>
<li><a class="el" href="group__PJ__SOCK.htm#ga21be8c2a1eb582bd13a801d4285f3ef9">pj_sock_send()</a></li>
<li><a class="el" href="group__PJ__SOCK.htm#ga9a84c286a4b7061503628b02d62f249a">pj_sock_sendto()</a></li>
<li><a class="el" href="group__PJ__SOCK.htm#gaef84c78edb396f0e1522117c48bce530">pj_sock_recv()</a></li>
<li><a class="el" href="group__PJ__SOCK.htm#gaa8bf01a1a29b8399d4eaf08bf278579a">pj_sock_recvfrom()</a></li>
<li><a class="el" href="group__PJ__SOCK.htm#ga173d6da92ef0a4f0df062bf377b4d626">pj_sock_bind()</a></li>
<li><a class="el" href="group__PJ__SOCK.htm#gab351de456e475d5c50289a1cb079a8fe">pj_sock_connect()</a></li>
<li><a class="el" href="group__PJ__SOCK.htm#ga6ca05fa6aa8db88c19a60d793fa0cc6b">pj_sock_listen()</a></li>
<li><a class="el" href="group__PJ__SOCK.htm#ga51f53c8010bd8194e83c96e105f3c609">pj_sock_accept()</a></li>
<li><a class="el" href="group__pj__addr__resolve.htm#ga7c8264aa7743594d31766679dbae0b88">pj_gethostbyname()</a></li>
</ul>
<p>This file is <b>pjlib-test/sock.c</b></p>
<div class="fragment"><pre class="fragment"><span class="comment">/* $Id: sock.c 3761 2011-09-21 04:54:27Z bennylp $ */</span>
<span class="comment">/* </span>
<span class="comment"> * Copyright (C) 2008-2011 Teluu Inc. (http://www.teluu.com)</span>
<span class="comment"> * Copyright (C) 2003-2008 Benny Prijono &lt;benny@prijono.org&gt;</span>
<span class="comment"> *</span>
<span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="comment"> * (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment"> * GNU General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU General Public License</span>
<span class="comment"> * along with this program; if not, write to the Free Software</span>
<span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA </span>
<span class="comment"> */</span>
<span class="preprocessor">#include &lt;pjlib.h&gt;</span>
<span class="preprocessor">#include &quot;test.h&quot;</span>


<span class="preprocessor">#if INCLUDE_SOCK_TEST</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define UDP_PORT        51234</span>
<span class="preprocessor"></span><span class="preprocessor">#define TCP_PORT        (UDP_PORT+10)</span>
<span class="preprocessor"></span><span class="preprocessor">#define BIG_DATA_LEN    8192</span>
<span class="preprocessor"></span><span class="preprocessor">#define ADDRESS         &quot;127.0.0.1&quot;</span>
<span class="preprocessor"></span>
<span class="keyword">static</span> <span class="keywordtype">char</span> bigdata[BIG_DATA_LEN];
<span class="keyword">static</span> <span class="keywordtype">char</span> bigbuffer[BIG_DATA_LEN];

<span class="comment">/* Macro for checking the value of &quot;sin_len&quot; member of sockaddr</span>
<span class="comment"> * (it must always be zero).</span>
<span class="comment"> */</span>
<span class="preprocessor">#if defined(PJ_SOCKADDR_HAS_LEN) &amp;&amp; PJ_SOCKADDR_HAS_LEN!=0</span>
<span class="preprocessor"></span><span class="preprocessor">#   define CHECK_SA_ZERO_LEN(addr, ret) \</span>
<span class="preprocessor">        if (((pj_addr_hdr*)(addr))-&gt;sa_zero_len != 0) \</span>
<span class="preprocessor">            return ret</span>
<span class="preprocessor"></span><span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor">#   define CHECK_SA_ZERO_LEN(addr, ret)</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

<span class="keyword">static</span> <span class="keywordtype">int</span> format_test(<span class="keywordtype">void</span>)
{
    <a class="code" href="structpj__str__t.htm">pj_str_t</a> s = <a class="code" href="group__PJ__PSTR.htm#ga20fa0c4d9ccddd0822a775730cf4a867">pj_str</a>(ADDRESS);
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p;
    <a class="code" href="structpj__in__addr.htm">pj_in_addr</a> addr;
    <span class="keywordtype">char</span> zero[64];
    <a class="code" href="structpj__sockaddr__in.htm">pj_sockaddr_in</a> addr2;
    <span class="keyword">const</span> <a class="code" href="structpj__str__t.htm">pj_str_t</a> *hostname;
    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> A[] = {127, 0, 0, 1};

    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;...format_test()&quot;</span>));
    
    <span class="comment">/* pj_inet_aton() */</span>
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga6f10f1bd1d75f2036b90f561df7eabd1">pj_inet_aton</a>(&amp;s, &amp;addr) != 1)
        <span class="keywordflow">return</span> -10;
    
    <span class="comment">/* Check the result. */</span>
    p = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;addr;
    <span class="keywordflow">if</span> (p[0]!=A[0] || p[1]!=A[1] || p[2]!=A[2] || p[3]!=A[3]) {
        <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;  error: mismatched address. p0=%d, p1=%d, &quot;</span>
                          <span class="stringliteral">&quot;p2=%d, p3=%d&quot;</span>, p[0] &amp; 0xFF, p[1] &amp; 0xFF, 
                           p[2] &amp; 0xFF, p[3] &amp; 0xFF));
        <span class="keywordflow">return</span> -15;
    }

    <span class="comment">/* pj_inet_ntoa() */</span>
    p = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*) <a class="code" href="group__PJ__SOCK.htm#ga399118ab0e5fea21ba5599caa260bc20">pj_inet_ntoa</a>(addr);
    <span class="keywordflow">if</span> (!p)
        <span class="keywordflow">return</span> -20;

    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__PSTR.htm#ga3321b5cee71785a7b450ad29afe0895b">pj_strcmp2</a>(&amp;s, (<span class="keywordtype">char</span>*)p) != 0)
        <span class="keywordflow">return</span> -22;

<span class="preprocessor">#if defined(PJ_HAS_IPV6) &amp;&amp; PJ_HAS_IPV6!=0</span>
<span class="preprocessor"></span>    <span class="comment">/* pj_inet_pton() */</span>
    <span class="comment">/* pj_inet_ntop() */</span>
    {
        <span class="keyword">const</span> <a class="code" href="structpj__str__t.htm">pj_str_t</a> s_ipv4 = <a class="code" href="group__PJ__PSTR.htm#ga20fa0c4d9ccddd0822a775730cf4a867">pj_str</a>(<span class="stringliteral">&quot;127.0.0.1&quot;</span>);
        <span class="keyword">const</span> <a class="code" href="structpj__str__t.htm">pj_str_t</a> s_ipv6 = <a class="code" href="group__PJ__PSTR.htm#ga20fa0c4d9ccddd0822a775730cf4a867">pj_str</a>(<span class="stringliteral">&quot;fe80::2ff:83ff:fe7c:8b42&quot;</span>);
        <span class="keywordtype">char</span> buf_ipv4[PJ_INET_ADDRSTRLEN];
        <span class="keywordtype">char</span> buf_ipv6[PJ_INET6_ADDRSTRLEN];
        <a class="code" href="structpj__in__addr.htm">pj_in_addr</a> ipv4;
        <a class="code" href="unionpj__in6__addr.htm">pj_in6_addr</a> ipv6;

        <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga8fdeab44dae09560b1f87cf6570c97e5">pj_inet_pton</a>(<a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>(), &amp;s_ipv4, &amp;ipv4) != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>)
            <span class="keywordflow">return</span> -24;

        p = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;ipv4;
        <span class="keywordflow">if</span> (p[0]!=A[0] || p[1]!=A[1] || p[2]!=A[2] || p[3]!=A[3]) {
            <span class="keywordflow">return</span> -25;
        }

        <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga8fdeab44dae09560b1f87cf6570c97e5">pj_inet_pton</a>(<a class="code" href="group__PJ__SOCK.htm#ga60a867be35581f776aa88156505309de">pj_AF_INET6</a>(), &amp;s_ipv6, &amp;ipv6) != PJ_SUCCESS)
            <span class="keywordflow">return</span> -26;

        p = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;ipv6;
        <span class="keywordflow">if</span> (p[0] != 0xfe || p[1] != 0x80 || p[2] != 0 || p[3] != 0 ||
            p[4] != 0 || p[5] != 0 || p[6] != 0 || p[7] != 0 ||
            p[8] != 0x02 || p[9] != 0xff || p[10] != 0x83 || p[11] != 0xff ||
            p[12]!=0xfe || p[13]!=0x7c || p[14] != 0x8b || p[15]!=0x42)
        {
            <span class="keywordflow">return</span> -27;
        }

        <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga506ba0f8230021a6cdd1bdab22c32e2e">pj_inet_ntop</a>(<a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>(), &amp;ipv4, buf_ipv4, <span class="keyword">sizeof</span>(buf_ipv4)) != PJ_SUCCESS)
            <span class="keywordflow">return</span> -28;
        <span class="keywordflow">if</span> (<a class="code" href="group__PJ__PSTR.htm#ga508848e33f034d920be8333ccdf7e077">pj_stricmp2</a>(&amp;s_ipv4, buf_ipv4) != 0)
            <span class="keywordflow">return</span> -29;

        <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga506ba0f8230021a6cdd1bdab22c32e2e">pj_inet_ntop</a>(<a class="code" href="group__PJ__SOCK.htm#ga60a867be35581f776aa88156505309de">pj_AF_INET6</a>(), &amp;ipv6, buf_ipv6, <span class="keyword">sizeof</span>(buf_ipv6)) != PJ_SUCCESS)
            <span class="keywordflow">return</span> -30;
        <span class="keywordflow">if</span> (<a class="code" href="group__PJ__PSTR.htm#ga508848e33f034d920be8333ccdf7e077">pj_stricmp2</a>(&amp;s_ipv6, buf_ipv6) != 0)
            <span class="keywordflow">return</span> -31;
    }

<span class="preprocessor">#endif  </span><span class="comment">/* PJ_HAS_IPV6 */</span>

    <span class="comment">/* Test that pj_sockaddr_in_init() initialize the whole structure, </span>
<span class="comment">     * including sin_zero.</span>
<span class="comment">     */</span>
    <a class="code" href="group__PJ__SOCK.htm#gae6169f27eb956287681a46ca9fecdafc">pj_sockaddr_in_init</a>(&amp;addr2, 0, 1000);
    <a class="code" href="group__PJ__PSTR.htm#gafa92001573289c87313c660146369fa3">pj_bzero</a>(zero, <span class="keyword">sizeof</span>(zero));
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__PSTR.htm#ga81417b253e8d0f658d2fe73e9eeb6bb5">pj_memcmp</a>(addr2.<a class="code" href="structpj__sockaddr__in.htm#a1acecf251350478af133d303d8704265">sin_zero</a>, zero, <span class="keyword">sizeof</span>(addr2.<a class="code" href="structpj__sockaddr__in.htm#a1acecf251350478af133d303d8704265">sin_zero</a>)) != 0)
        <span class="keywordflow">return</span> -35;

    <span class="comment">/* pj_gethostname() */</span>
    hostname = <a class="code" href="group__PJ__SOCK.htm#ga47bc19975b9e88fc86d4bf43ffd2a17f">pj_gethostname</a>();
    <span class="keywordflow">if</span> (!hostname || !hostname-&gt;<a class="code" href="structpj__str__t.htm#a4eb3153e4363a93f65f5c728911168d4">ptr</a> || !hostname-&gt;<a class="code" href="structpj__str__t.htm#a46788480bdb4080083dcc8965811e015">slen</a>)
        <span class="keywordflow">return</span> -40;

    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;....hostname is %.*s&quot;</span>, 
              (<span class="keywordtype">int</span>)hostname-&gt;<a class="code" href="structpj__str__t.htm#a46788480bdb4080083dcc8965811e015">slen</a>, hostname-&gt;<a class="code" href="structpj__str__t.htm#a4eb3153e4363a93f65f5c728911168d4">ptr</a>));

    <span class="comment">/* pj_gethostaddr() */</span>

    <span class="comment">/* Various constants */</span>
<span class="preprocessor">#if !defined(PJ_SYMBIAN) || PJ_SYMBIAN==0</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#gab432f047e1fc825427da8e69b2b79b16">PJ_AF_INET</a>==0xFFFF) <span class="keywordflow">return</span> -5500;
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga4092bf46ceb78d847c0ed8ea48a41c7d">PJ_AF_INET6</a>==0xFFFF) <span class="keywordflow">return</span> -5501;
    
    <span class="comment">/* 0xFFFF could be a valid SOL_SOCKET (e.g: on some Win or Mac) */</span>
    <span class="comment">//if (PJ_SOL_SOCKET==0xFFFF) return -5503;</span>
    
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga8d7b2d2566f35102de65c949f2b7bfbf">PJ_SOL_IP</a>==0xFFFF) <span class="keywordflow">return</span> -5502;
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#gaef769c018c4dacc0abcad2f8e50c4d44">PJ_SOL_TCP</a>==0xFFFF) <span class="keywordflow">return</span> -5510;
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga6adb3a705620c0d3e6b8f818e6635e2e">PJ_SOL_UDP</a>==0xFFFF) <span class="keywordflow">return</span> -5520;
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga573bc0c707807620528353b41bce927f">PJ_SOL_IPV6</a>==0xFFFF) <span class="keywordflow">return</span> -5530;

    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga2956ad61c83d89a6d05162fbf25f3189">PJ_SO_TYPE</a>==0xFFFF) <span class="keywordflow">return</span> -5540;
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga728a78d7c0f12efc7ff337707fc83c6a">PJ_SO_RCVBUF</a>==0xFFFF) <span class="keywordflow">return</span> -5550;
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga21788080c4678f2b27f8be649bc1a09a">PJ_SO_SNDBUF</a>==0xFFFF) <span class="keywordflow">return</span> -5560;
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga74b596544d0e34eb65072d9338c669af">PJ_TCP_NODELAY</a>==0xFFFF) <span class="keywordflow">return</span> -5570;
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga6de653f01377c35e4be52626f7a1a8a9">PJ_SO_REUSEADDR</a>==0xFFFF) <span class="keywordflow">return</span> -5580;

    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#gab8ece577d6b066445dc4dae7ce19d0db">PJ_MSG_OOB</a>==0xFFFF) <span class="keywordflow">return</span> -5590;
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga7cd045bfebde8359b3f05aafd1779120">PJ_MSG_PEEK</a>==0xFFFF) <span class="keywordflow">return</span> -5600;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> parse_test(<span class="keywordtype">void</span>)
{
<span class="preprocessor">#define IPv4    1</span>
<span class="preprocessor"></span><span class="preprocessor">#define IPv6    2</span>
<span class="preprocessor"></span>
    <span class="keyword">struct </span>test_t {
        <span class="keyword">const</span> <span class="keywordtype">char</span>  *input;
        <span class="keywordtype">int</span>          result_af;
        <span class="keyword">const</span> <span class="keywordtype">char</span>  *result_ip;
        <a class="code" href="group__PJ__BASIC.htm#ga47506d8dde1056c5c96d62f0df6ddf28">pj_uint16_t</a>  result_port;
    };
    <span class="keyword">struct </span>test_t valid_tests[] = 
    {
        <span class="comment">/* IPv4 */</span>
        { <span class="stringliteral">&quot;10.0.0.1:80&quot;</span>, IPv4, <span class="stringliteral">&quot;10.0.0.1&quot;</span>, 80},
        { <span class="stringliteral">&quot;10.0.0.1&quot;</span>, IPv4, <span class="stringliteral">&quot;10.0.0.1&quot;</span>, 0},
        { <span class="stringliteral">&quot;10.0.0.1:&quot;</span>, IPv4, <span class="stringliteral">&quot;10.0.0.1&quot;</span>, 0},
        { <span class="stringliteral">&quot;10.0.0.1:0&quot;</span>, IPv4, <span class="stringliteral">&quot;10.0.0.1&quot;</span>, 0},
        { <span class="stringliteral">&quot;:80&quot;</span>, IPv4, <span class="stringliteral">&quot;0.0.0.0&quot;</span>, 80},
        { <span class="stringliteral">&quot;:&quot;</span>, IPv4, <span class="stringliteral">&quot;0.0.0.0&quot;</span>, 0},
<span class="preprocessor">#if !PJ_SYMBIAN</span>
<span class="preprocessor"></span>        { <span class="stringliteral">&quot;localhost&quot;</span>, IPv4, <span class="stringliteral">&quot;127.0.0.1&quot;</span>, 0},
        { <span class="stringliteral">&quot;localhost:&quot;</span>, IPv4, <span class="stringliteral">&quot;127.0.0.1&quot;</span>, 0},
        { <span class="stringliteral">&quot;localhost:80&quot;</span>, IPv4, <span class="stringliteral">&quot;127.0.0.1&quot;</span>, 80},
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#if defined(PJ_HAS_IPV6) &amp;&amp; PJ_HAS_IPV6</span>
<span class="preprocessor"></span>        { <span class="stringliteral">&quot;fe::01:80&quot;</span>, IPv6, <span class="stringliteral">&quot;fe::01:80&quot;</span>, 0},
        { <span class="stringliteral">&quot;[fe::01]:80&quot;</span>, IPv6, <span class="stringliteral">&quot;fe::01&quot;</span>, 80},
        { <span class="stringliteral">&quot;fe::01&quot;</span>, IPv6, <span class="stringliteral">&quot;fe::01&quot;</span>, 0},
        { <span class="stringliteral">&quot;[fe::01]&quot;</span>, IPv6, <span class="stringliteral">&quot;fe::01&quot;</span>, 0},
        { <span class="stringliteral">&quot;fe::01:&quot;</span>, IPv6, <span class="stringliteral">&quot;fe::01&quot;</span>, 0},
        { <span class="stringliteral">&quot;[fe::01]:&quot;</span>, IPv6, <span class="stringliteral">&quot;fe::01&quot;</span>, 0},
        { <span class="stringliteral">&quot;::&quot;</span>, IPv6, <span class="stringliteral">&quot;::0&quot;</span>, 0},
        { <span class="stringliteral">&quot;[::]&quot;</span>, IPv6, <span class="stringliteral">&quot;::&quot;</span>, 0},
        { <span class="stringliteral">&quot;:::&quot;</span>, IPv6, <span class="stringliteral">&quot;::&quot;</span>, 0},
        { <span class="stringliteral">&quot;[::]:&quot;</span>, IPv6, <span class="stringliteral">&quot;::&quot;</span>, 0},
        { <span class="stringliteral">&quot;:::80&quot;</span>, IPv6, <span class="stringliteral">&quot;::&quot;</span>, 80},
        { <span class="stringliteral">&quot;[::]:80&quot;</span>, IPv6, <span class="stringliteral">&quot;::&quot;</span>, 80},
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    };
    <span class="keyword">struct </span>test_t invalid_tests[] = 
    {
        <span class="comment">/* IPv4 */</span>
        { <span class="stringliteral">&quot;10.0.0.1:abcd&quot;</span>, IPv4},   <span class="comment">/* port not numeric */</span>
        { <span class="stringliteral">&quot;10.0.0.1:-1&quot;</span>, IPv4},     <span class="comment">/* port contains illegal character */</span>
        { <span class="stringliteral">&quot;10.0.0.1:123456&quot;</span>, IPv4}, <span class="comment">/* port too big     */</span>
        { <span class="stringliteral">&quot;1.2.3.4.5:80&quot;</span>, IPv4},    <span class="comment">/* invalid IP */</span>
        { <span class="stringliteral">&quot;10:0:80&quot;</span>, IPv4},         <span class="comment">/* hostname has colon */</span>

<span class="preprocessor">#if defined(PJ_HAS_IPV6) &amp;&amp; PJ_HAS_IPV6</span>
<span class="preprocessor"></span>        { <span class="stringliteral">&quot;[fe::01]:abcd&quot;</span>, IPv6},   <span class="comment">/* port not numeric */</span>
        { <span class="stringliteral">&quot;[fe::01]:-1&quot;</span>, IPv6},     <span class="comment">/* port contains illegal character */</span>
        { <span class="stringliteral">&quot;[fe::01]:123456&quot;</span>, IPv6}, <span class="comment">/* port too big     */</span>
        { <span class="stringliteral">&quot;fe::01:02::03:04:80&quot;</span>, IPv6},     <span class="comment">/* invalid IP */</span>
        { <span class="stringliteral">&quot;[fe::01:02::03:04]:80&quot;</span>, IPv6},   <span class="comment">/* invalid IP */</span>
        { <span class="stringliteral">&quot;[fe:01&quot;</span>, IPv6},          <span class="comment">/* Unterminated bracket */</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    };

    <span class="keywordtype">unsigned</span> i;

    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;...IP address parsing&quot;</span>));

    <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="group__PJ__BASIC.htm#gacd8459212a1e5175eeb04e3a6cd76659">PJ_ARRAY_SIZE</a>(valid_tests); ++i) {
        <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> status;
        <a class="code" href="structpj__str__t.htm">pj_str_t</a> input;
        <a class="code" href="unionpj__sockaddr.htm">pj_sockaddr</a> addr, result;

        <span class="keywordflow">switch</span> (valid_tests[i].result_af) {
        <span class="keywordflow">case</span> IPv4:
            valid_tests[i].result_af = <a class="code" href="group__PJ__SOCK.htm#gab432f047e1fc825427da8e69b2b79b16">PJ_AF_INET</a>;
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> IPv6:
            valid_tests[i].result_af = <a class="code" href="group__PJ__SOCK.htm#ga4092bf46ceb78d847c0ed8ea48a41c7d">PJ_AF_INET6</a>;
            <span class="keywordflow">break</span>;
        <span class="keywordflow">default</span>:
            <a class="code" href="group__pj__assert.htm#ga981d47a5e9d7e9655473244839f0f5d3">pj_assert</a>(!<span class="stringliteral">&quot;Invalid AF!&quot;</span>);
            <span class="keywordflow">continue</span>;
        }

        <span class="comment">/* Try parsing with PJ_AF_UNSPEC */</span>
        status = <a class="code" href="group__PJ__SOCK.htm#ga1562332273aa3900dc549cffd5b5c4e4">pj_sockaddr_parse</a>(<a class="code" href="group__PJ__SOCK.htm#gadc28a871617da78cc6e52e5b5179505d">PJ_AF_UNSPEC</a>, 0, 
                                   <a class="code" href="group__PJ__PSTR.htm#ga5a57d48a802ff650d8e5186cf65b7c4a">pj_cstr</a>(&amp;input, valid_tests[i].input), 
                                   &amp;addr);
        <span class="keywordflow">if</span> (status != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(1,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;.... failed when parsing %s (i=%d)&quot;</span>, 
                      valid_tests[i].input, i));
            <span class="keywordflow">return</span> -10;
        }

        <span class="comment">/* Check &quot;sin_len&quot; member of parse result */</span>
        CHECK_SA_ZERO_LEN(&amp;addr, -20);

        <span class="comment">/* Build the correct result */</span>
        status = <a class="code" href="group__PJ__SOCK.htm#ga14a50bd931bd5ee1fcc064ad701d64b6">pj_sockaddr_init</a>(valid_tests[i].result_af,
                                  &amp;result,
                                  <a class="code" href="group__PJ__PSTR.htm#ga5a57d48a802ff650d8e5186cf65b7c4a">pj_cstr</a>(&amp;input, valid_tests[i].result_ip), 
                                  valid_tests[i].result_port);
        <span class="keywordflow">if</span> (status != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(1,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;.... error building IP address %s&quot;</span>, 
                      valid_tests[i].input));
            <span class="keywordflow">return</span> -30;
        }

        <span class="comment">/* Compare the result */</span>
        <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga5048603d35a51e80268e961697623141">pj_sockaddr_cmp</a>(&amp;addr, &amp;result) != 0) {
            <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(1,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;.... parsed result mismatched for %s&quot;</span>, 
                      valid_tests[i].input));
            <span class="keywordflow">return</span> -40;
        }

        <span class="comment">/* Parse again with the specified af */</span>
        status = <a class="code" href="group__PJ__SOCK.htm#ga1562332273aa3900dc549cffd5b5c4e4">pj_sockaddr_parse</a>(valid_tests[i].result_af, 0, 
                                   <a class="code" href="group__PJ__PSTR.htm#ga5a57d48a802ff650d8e5186cf65b7c4a">pj_cstr</a>(&amp;input, valid_tests[i].input), 
                                   &amp;addr);
        <span class="keywordflow">if</span> (status != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(1,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;.... failed when parsing %s&quot;</span>, 
                      valid_tests[i].input));
            <span class="keywordflow">return</span> -50;
        }

        <span class="comment">/* Check &quot;sin_len&quot; member of parse result */</span>
        CHECK_SA_ZERO_LEN(&amp;addr, -55);

        <span class="comment">/* Compare the result again */</span>
        <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga5048603d35a51e80268e961697623141">pj_sockaddr_cmp</a>(&amp;addr, &amp;result) != 0) {
            <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(1,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;.... parsed result mismatched for %s&quot;</span>, 
                      valid_tests[i].input));
            <span class="keywordflow">return</span> -60;
        }
    }

    <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="group__PJ__BASIC.htm#gacd8459212a1e5175eeb04e3a6cd76659">PJ_ARRAY_SIZE</a>(invalid_tests); ++i) {
        <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> status;
        <a class="code" href="structpj__str__t.htm">pj_str_t</a> input;
        <a class="code" href="unionpj__sockaddr.htm">pj_sockaddr</a> addr;

        <span class="keywordflow">switch</span> (invalid_tests[i].result_af) {
        <span class="keywordflow">case</span> IPv4:
            invalid_tests[i].result_af = <a class="code" href="group__PJ__SOCK.htm#gab432f047e1fc825427da8e69b2b79b16">PJ_AF_INET</a>;
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> IPv6:
            invalid_tests[i].result_af = <a class="code" href="group__PJ__SOCK.htm#ga4092bf46ceb78d847c0ed8ea48a41c7d">PJ_AF_INET6</a>;
            <span class="keywordflow">break</span>;
        <span class="keywordflow">default</span>:
            <a class="code" href="group__pj__assert.htm#ga981d47a5e9d7e9655473244839f0f5d3">pj_assert</a>(!<span class="stringliteral">&quot;Invalid AF!&quot;</span>);
            <span class="keywordflow">continue</span>;
        }

        <span class="comment">/* Try parsing with PJ_AF_UNSPEC */</span>
        status = <a class="code" href="group__PJ__SOCK.htm#ga1562332273aa3900dc549cffd5b5c4e4">pj_sockaddr_parse</a>(<a class="code" href="group__PJ__SOCK.htm#gadc28a871617da78cc6e52e5b5179505d">PJ_AF_UNSPEC</a>, 0, 
                                   <a class="code" href="group__PJ__PSTR.htm#ga5a57d48a802ff650d8e5186cf65b7c4a">pj_cstr</a>(&amp;input, invalid_tests[i].input), 
                                   &amp;addr);
        <span class="keywordflow">if</span> (status == <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(1,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;.... expecting failure when parsing %s&quot;</span>, 
                      invalid_tests[i].input));
            <span class="keywordflow">return</span> -100;
        }
    }

    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> purity_test(<span class="keywordtype">void</span>)
{
    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;...purity_test()&quot;</span>));

<span class="preprocessor">#if defined(PJ_SOCKADDR_HAS_LEN) &amp;&amp; PJ_SOCKADDR_HAS_LEN!=0</span>
<span class="preprocessor"></span>    <span class="comment">/* Check on &quot;sin_len&quot; member of sockaddr */</span>
    {
        <span class="keyword">const</span> <a class="code" href="structpj__str__t.htm">pj_str_t</a> str_ip = {<span class="stringliteral">&quot;1.1.1.1&quot;</span>, 7};
        <a class="code" href="unionpj__sockaddr.htm">pj_sockaddr</a> addr[16];
        <a class="code" href="structpj__addrinfo.htm">pj_addrinfo</a> ai[16];
        <span class="keywordtype">unsigned</span> cnt;
        <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> rc;

        <span class="comment">/* pj_enum_ip_interface() */</span>
        cnt = <a class="code" href="group__PJ__BASIC.htm#gacd8459212a1e5175eeb04e3a6cd76659">PJ_ARRAY_SIZE</a>(addr);
        rc = <a class="code" href="group__pj__ip__helper.htm#gab983d56df83721c32feeb2fe0d394e69">pj_enum_ip_interface</a>(<a class="code" href="group__PJ__SOCK.htm#ga70ea77cd531607c6c3ce586d6fbd007d">pj_AF_UNSPEC</a>(), &amp;cnt, addr);
        <span class="keywordflow">if</span> (rc == <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            <span class="keywordflow">while</span> (cnt--)
                CHECK_SA_ZERO_LEN(&amp;addr[cnt], -10);
        }

        <span class="comment">/* pj_gethostip() on IPv4 */</span>
        rc = <a class="code" href="group__pj__addr__resolve.htm#ga410b1bd02dcabf108b129e95368beef4">pj_gethostip</a>(<a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>(), &amp;addr[0]);
        <span class="keywordflow">if</span> (rc == <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>)
            CHECK_SA_ZERO_LEN(&amp;addr[0], -20);

        <span class="comment">/* pj_gethostip() on IPv6 */</span>
        rc = <a class="code" href="group__pj__addr__resolve.htm#ga410b1bd02dcabf108b129e95368beef4">pj_gethostip</a>(<a class="code" href="group__PJ__SOCK.htm#ga60a867be35581f776aa88156505309de">pj_AF_INET6</a>(), &amp;addr[0]);
        <span class="keywordflow">if</span> (rc == <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>)
            CHECK_SA_ZERO_LEN(&amp;addr[0], -30);

        <span class="comment">/* pj_getdefaultipinterface() on IPv4 */</span>
        rc = <a class="code" href="group__pj__addr__resolve.htm#gae9a1ddbc8b068fad022db4661bcb9937">pj_getdefaultipinterface</a>(<a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>(), &amp;addr[0]);
        <span class="keywordflow">if</span> (rc == <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>)
            CHECK_SA_ZERO_LEN(&amp;addr[0], -40);

        <span class="comment">/* pj_getdefaultipinterface() on IPv6 */</span>
        rc = <a class="code" href="group__pj__addr__resolve.htm#gae9a1ddbc8b068fad022db4661bcb9937">pj_getdefaultipinterface</a>(<a class="code" href="group__PJ__SOCK.htm#ga60a867be35581f776aa88156505309de">pj_AF_INET6</a>(), &amp;addr[0]);
        <span class="keywordflow">if</span> (rc == <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>)
            CHECK_SA_ZERO_LEN(&amp;addr[0], -50);

        <span class="comment">/* pj_getaddrinfo() on a host name */</span>
        cnt = <a class="code" href="group__PJ__BASIC.htm#gacd8459212a1e5175eeb04e3a6cd76659">PJ_ARRAY_SIZE</a>(ai);
        rc = <a class="code" href="group__pj__addr__resolve.htm#gaaf5df28bb11ef770eb4ef5cca7b8f9b2">pj_getaddrinfo</a>(<a class="code" href="group__PJ__SOCK.htm#ga70ea77cd531607c6c3ce586d6fbd007d">pj_AF_UNSPEC</a>(), <a class="code" href="group__PJ__SOCK.htm#ga47bc19975b9e88fc86d4bf43ffd2a17f">pj_gethostname</a>(), &amp;cnt, ai);
        <span class="keywordflow">if</span> (rc == <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            <span class="keywordflow">while</span> (cnt--)
                CHECK_SA_ZERO_LEN(&amp;ai[cnt].ai_addr, -60);
        }

        <span class="comment">/* pj_getaddrinfo() on an IP address */</span>
        cnt = <a class="code" href="group__PJ__BASIC.htm#gacd8459212a1e5175eeb04e3a6cd76659">PJ_ARRAY_SIZE</a>(ai);
        rc = <a class="code" href="group__pj__addr__resolve.htm#gaaf5df28bb11ef770eb4ef5cca7b8f9b2">pj_getaddrinfo</a>(<a class="code" href="group__PJ__SOCK.htm#ga70ea77cd531607c6c3ce586d6fbd007d">pj_AF_UNSPEC</a>(), &amp;str_ip, &amp;cnt, ai);
        <span class="keywordflow">if</span> (rc == <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            <a class="code" href="group__pj__assert.htm#ga981d47a5e9d7e9655473244839f0f5d3">pj_assert</a>(cnt == 1);
            CHECK_SA_ZERO_LEN(&amp;ai[0].ai_addr, -70);
        }
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> simple_sock_test(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> types[2];
    <a class="code" href="group__PJ__BASIC.htm#ga5ccc87de27d1236bc31ae3673d153984">pj_sock_t</a> sock;
    <span class="keywordtype">int</span> i;
    <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> rc = PJ_SUCCESS;

    types[0] = <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>();
    types[1] = <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>();

    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;...simple_sock_test()&quot;</span>));

    <span class="keywordflow">for</span> (i=0; i&lt;(int)(<span class="keyword">sizeof</span>(types)/<span class="keyword">sizeof</span>(types[0])); ++i) {
        
        rc = <a class="code" href="group__PJ__SOCK.htm#gaeec96c063aafa1d7c19b33590997bcff">pj_sock_socket</a>(<a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>(), types[i], 0, &amp;sock);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            app_perror(<span class="stringliteral">&quot;...error: unable to create socket&quot;</span>, rc);
            <span class="keywordflow">break</span>;
        } <span class="keywordflow">else</span> {
            rc = <a class="code" href="group__PJ__SOCK.htm#ga2f8faea76a64620b13a720227df927bb">pj_sock_close</a>(sock);
            <span class="keywordflow">if</span> (rc != 0) {
                app_perror(<span class="stringliteral">&quot;...error: close socket&quot;</span>, rc);
                <span class="keywordflow">break</span>;
            }
        }
    }
    <span class="keywordflow">return</span> rc;
}


<span class="keyword">static</span> <span class="keywordtype">int</span> send_recv_test(<span class="keywordtype">int</span> sock_type,
                          <a class="code" href="group__PJ__BASIC.htm#ga5ccc87de27d1236bc31ae3673d153984">pj_sock_t</a> ss, <a class="code" href="group__PJ__BASIC.htm#ga5ccc87de27d1236bc31ae3673d153984">pj_sock_t</a> cs,
                          <a class="code" href="structpj__sockaddr__in.htm">pj_sockaddr_in</a> *dstaddr, <a class="code" href="structpj__sockaddr__in.htm">pj_sockaddr_in</a> *srcaddr, 
                          <span class="keywordtype">int</span> addrlen)
{
    <span class="keyword">enum</span> { DATA_LEN = 16 };
    <span class="keywordtype">char</span> senddata[DATA_LEN+4], recvdata[DATA_LEN+4];
    <a class="code" href="group__PJ__BASIC.htm#ga173588cd6381f3ad354c23c26929093a">pj_ssize_t</a> sent, received, total_received;
    <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> rc;

    TRACE_((<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;....create_random_string()&quot;</span>));
    <a class="code" href="group__PJ__PSTR.htm#gae0f30eb53208168b12b6c8e50649ce89">pj_create_random_string</a>(senddata, DATA_LEN);
    senddata[DATA_LEN-1] = <span class="charliteral">&#39;\0&#39;</span>;

    <span class="comment">/*</span>
<span class="comment">     * Test send/recv small data.</span>
<span class="comment">     */</span>
    TRACE_((<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;....sendto()&quot;</span>));
    <span class="keywordflow">if</span> (dstaddr) {
        sent = DATA_LEN;
        rc = <a class="code" href="group__PJ__SOCK.htm#ga9a84c286a4b7061503628b02d62f249a">pj_sock_sendto</a>(cs, senddata, &amp;sent, 0, dstaddr, addrlen);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a> || sent != DATA_LEN) {
            app_perror(<span class="stringliteral">&quot;...sendto error&quot;</span>, rc);
            rc = -140; <span class="keywordflow">goto</span> on_error;
        }
    } <span class="keywordflow">else</span> {
        sent = DATA_LEN;
        rc = <a class="code" href="group__PJ__SOCK.htm#ga21be8c2a1eb582bd13a801d4285f3ef9">pj_sock_send</a>(cs, senddata, &amp;sent, 0);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a> || sent != DATA_LEN) {
            app_perror(<span class="stringliteral">&quot;...send error&quot;</span>, rc);
            rc = -145; <span class="keywordflow">goto</span> on_error;
        }
    }

    TRACE_((<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;....recv()&quot;</span>));
    <span class="keywordflow">if</span> (srcaddr) {
        <a class="code" href="structpj__sockaddr__in.htm">pj_sockaddr_in</a> addr;
        <span class="keywordtype">int</span> srclen = <span class="keyword">sizeof</span>(addr);
        
        <a class="code" href="group__PJ__PSTR.htm#gafa92001573289c87313c660146369fa3">pj_bzero</a>(&amp;addr, <span class="keyword">sizeof</span>(addr));

        received = DATA_LEN;
        rc = <a class="code" href="group__PJ__SOCK.htm#gaa8bf01a1a29b8399d4eaf08bf278579a">pj_sock_recvfrom</a>(ss, recvdata, &amp;received, 0, &amp;addr, &amp;srclen);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a> || received != DATA_LEN) {
            app_perror(<span class="stringliteral">&quot;...recvfrom error&quot;</span>, rc);
            rc = -150; <span class="keywordflow">goto</span> on_error;
        }
        <span class="keywordflow">if</span> (srclen != addrlen)
            <span class="keywordflow">return</span> -151;
        <span class="keywordflow">if</span> (<a class="code" href="group__PJ__SOCK.htm#ga5048603d35a51e80268e961697623141">pj_sockaddr_cmp</a>(&amp;addr, srcaddr) != 0) {
            <span class="keywordtype">char</span> srcaddr_str[32], addr_str[32];
            strcpy(srcaddr_str, <a class="code" href="group__PJ__SOCK.htm#ga399118ab0e5fea21ba5599caa260bc20">pj_inet_ntoa</a>(srcaddr-&gt;<a class="code" href="structpj__sockaddr__in.htm#ad1ed5a34d99da0d23e65b3b3b5fad228">sin_addr</a>));
            strcpy(addr_str, <a class="code" href="group__PJ__SOCK.htm#ga399118ab0e5fea21ba5599caa260bc20">pj_inet_ntoa</a>(addr.<a class="code" href="structpj__sockaddr__in.htm#ad1ed5a34d99da0d23e65b3b3b5fad228">sin_addr</a>));
            <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;...error: src address mismatch (original=%s, &quot;</span>
                              <span class="stringliteral">&quot;recvfrom addr=%s)&quot;</span>, 
                              srcaddr_str, addr_str));
            <span class="keywordflow">return</span> -152;
        }
        
    } <span class="keywordflow">else</span> {
        <span class="comment">/* Repeat recv() until all data is received.</span>
<span class="comment">         * This applies only for non-UDP of course, since for UDP</span>
<span class="comment">         * we would expect all data to be received in one packet.</span>
<span class="comment">         */</span>
        total_received = 0;
        <span class="keywordflow">do</span> {
            received = DATA_LEN-total_received;
            rc = <a class="code" href="group__PJ__SOCK.htm#gaef84c78edb396f0e1522117c48bce530">pj_sock_recv</a>(ss, recvdata+total_received, &amp;received, 0);
            <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
                app_perror(<span class="stringliteral">&quot;...recv error&quot;</span>, rc);
                rc = -155; <span class="keywordflow">goto</span> on_error;
            }
            <span class="keywordflow">if</span> (received &lt;= 0) {
                <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;...error: socket has closed! (received=%d)&quot;</span>,
                          received));
                rc = -156; <span class="keywordflow">goto</span> on_error;
            }
            <span class="keywordflow">if</span> (received != DATA_LEN-total_received) {
                <span class="keywordflow">if</span> (sock_type != <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>()) {
                    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;...error: expecting %u bytes, got %u bytes&quot;</span>,
                              DATA_LEN-total_received, received));
                    rc = -157; <span class="keywordflow">goto</span> on_error;
                }
            }
            total_received += received;
        } <span class="keywordflow">while</span> (total_received &lt; DATA_LEN);
    }

    TRACE_((<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;....memcmp()&quot;</span>));
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__PSTR.htm#ga81417b253e8d0f658d2fe73e9eeb6bb5">pj_memcmp</a>(senddata, recvdata, DATA_LEN) != 0) {
        <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;...error: received data mismatch &quot;</span>
                     <span class="stringliteral">&quot;(got:&#39;%s&#39; expecting:&#39;%s&#39;&quot;</span>,
                     recvdata, senddata));
        rc = -160; <span class="keywordflow">goto</span> on_error;
    }

    <span class="comment">/*</span>
<span class="comment">     * Test send/recv big data.</span>
<span class="comment">     */</span>
    TRACE_((<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;....sendto()&quot;</span>));
    <span class="keywordflow">if</span> (dstaddr) {
        sent = BIG_DATA_LEN;
        rc = <a class="code" href="group__PJ__SOCK.htm#ga9a84c286a4b7061503628b02d62f249a">pj_sock_sendto</a>(cs, bigdata, &amp;sent, 0, dstaddr, addrlen);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a> || sent != BIG_DATA_LEN) {
            app_perror(<span class="stringliteral">&quot;...sendto error&quot;</span>, rc);
            rc = -161; <span class="keywordflow">goto</span> on_error;
        }
    } <span class="keywordflow">else</span> {
        sent = BIG_DATA_LEN;
        rc = <a class="code" href="group__PJ__SOCK.htm#ga21be8c2a1eb582bd13a801d4285f3ef9">pj_sock_send</a>(cs, bigdata, &amp;sent, 0);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a> || sent != BIG_DATA_LEN) {
            app_perror(<span class="stringliteral">&quot;...send error&quot;</span>, rc);
            rc = -165; <span class="keywordflow">goto</span> on_error;
        }
    }

    TRACE_((<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;....recv()&quot;</span>));

    <span class="comment">/* Repeat recv() until all data is received.</span>
<span class="comment">     * This applies only for non-UDP of course, since for UDP</span>
<span class="comment">     * we would expect all data to be received in one packet.</span>
<span class="comment">     */</span>
    total_received = 0;
    <span class="keywordflow">do</span> {
        received = BIG_DATA_LEN-total_received;
        rc = <a class="code" href="group__PJ__SOCK.htm#gaef84c78edb396f0e1522117c48bce530">pj_sock_recv</a>(ss, bigbuffer+total_received, &amp;received, 0);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            app_perror(<span class="stringliteral">&quot;...recv error&quot;</span>, rc);
            rc = -170; <span class="keywordflow">goto</span> on_error;
        }
        <span class="keywordflow">if</span> (received &lt;= 0) {
            <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;...error: socket has closed! (received=%d)&quot;</span>,
                      received));
            rc = -173; <span class="keywordflow">goto</span> on_error;
        }
        <span class="keywordflow">if</span> (received != BIG_DATA_LEN-total_received) {
            <span class="keywordflow">if</span> (sock_type != <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>()) {
                <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;...error: expecting %u bytes, got %u bytes&quot;</span>,
                          BIG_DATA_LEN-total_received, received));
                rc = -176; <span class="keywordflow">goto</span> on_error;
            }
        }
        total_received += received;
    } <span class="keywordflow">while</span> (total_received &lt; BIG_DATA_LEN);

    TRACE_((<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;....memcmp()&quot;</span>));
    <span class="keywordflow">if</span> (<a class="code" href="group__PJ__PSTR.htm#ga81417b253e8d0f658d2fe73e9eeb6bb5">pj_memcmp</a>(bigdata, bigbuffer, BIG_DATA_LEN) != 0) {
        <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;...error: received data has been altered!&quot;</span>));
        rc = -180; <span class="keywordflow">goto</span> on_error;
    }
    
    rc = 0;

on_error:
    <span class="keywordflow">return</span> rc;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> udp_test(<span class="keywordtype">void</span>)
{
    <a class="code" href="group__PJ__BASIC.htm#ga5ccc87de27d1236bc31ae3673d153984">pj_sock_t</a> cs = PJ_INVALID_SOCKET, ss = PJ_INVALID_SOCKET;
    <a class="code" href="structpj__sockaddr__in.htm">pj_sockaddr_in</a> dstaddr, srcaddr;
    <a class="code" href="structpj__str__t.htm">pj_str_t</a> s;
    <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> rc = 0, retval;

    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;...udp_test()&quot;</span>));

    rc = <a class="code" href="group__PJ__SOCK.htm#gaeec96c063aafa1d7c19b33590997bcff">pj_sock_socket</a>(<a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>(), <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), 0, &amp;ss);
    <span class="keywordflow">if</span> (rc != 0) {
        app_perror(<span class="stringliteral">&quot;...error: unable to create socket&quot;</span>, rc);
        <span class="keywordflow">return</span> -100;
    }

    rc = <a class="code" href="group__PJ__SOCK.htm#gaeec96c063aafa1d7c19b33590997bcff">pj_sock_socket</a>(<a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>(), <a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), 0, &amp;cs);
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">return</span> -110;

    <span class="comment">/* Bind server socket. */</span>
    <a class="code" href="group__PJ__PSTR.htm#gafa92001573289c87313c660146369fa3">pj_bzero</a>(&amp;dstaddr, <span class="keyword">sizeof</span>(dstaddr));
    dstaddr.<a class="code" href="structpj__sockaddr__in.htm#ab298fd61a3f2bf3036fe414740a53cc6">sin_family</a> = <a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>();
    dstaddr.<a class="code" href="structpj__sockaddr__in.htm#a0e60b93d03fa052211bb6131e64bdda1">sin_port</a> = <a class="code" href="group__PJ__SOCK.htm#ga25ce2f95b79d3556375804123a5eb77e">pj_htons</a>(UDP_PORT);
    dstaddr.<a class="code" href="structpj__sockaddr__in.htm#ad1ed5a34d99da0d23e65b3b3b5fad228">sin_addr</a> = <a class="code" href="group__PJ__SOCK.htm#gabcef38a6393a6c8e398b7e3ee2dac7d1">pj_inet_addr</a>(<a class="code" href="group__PJ__PSTR.htm#ga5a57d48a802ff650d8e5186cf65b7c4a">pj_cstr</a>(&amp;s, ADDRESS));
    
    <span class="keywordflow">if</span> ((rc=<a class="code" href="group__PJ__SOCK.htm#ga173d6da92ef0a4f0df062bf377b4d626">pj_sock_bind</a>(ss, &amp;dstaddr, <span class="keyword">sizeof</span>(dstaddr))) != 0) {
        app_perror(<span class="stringliteral">&quot;...bind error udp:&quot;</span>ADDRESS, rc);
        rc = -120; <span class="keywordflow">goto</span> on_error;
    }

    <span class="comment">/* Bind client socket. */</span>
    <a class="code" href="group__PJ__PSTR.htm#gafa92001573289c87313c660146369fa3">pj_bzero</a>(&amp;srcaddr, <span class="keyword">sizeof</span>(srcaddr));
    srcaddr.<a class="code" href="structpj__sockaddr__in.htm#ab298fd61a3f2bf3036fe414740a53cc6">sin_family</a> = <a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>();
    srcaddr.<a class="code" href="structpj__sockaddr__in.htm#a0e60b93d03fa052211bb6131e64bdda1">sin_port</a> = <a class="code" href="group__PJ__SOCK.htm#ga25ce2f95b79d3556375804123a5eb77e">pj_htons</a>(UDP_PORT-1);
    srcaddr.<a class="code" href="structpj__sockaddr__in.htm#ad1ed5a34d99da0d23e65b3b3b5fad228">sin_addr</a> = <a class="code" href="group__PJ__SOCK.htm#gabcef38a6393a6c8e398b7e3ee2dac7d1">pj_inet_addr</a>(<a class="code" href="group__PJ__PSTR.htm#ga5a57d48a802ff650d8e5186cf65b7c4a">pj_cstr</a>(&amp;s, ADDRESS));

    <span class="keywordflow">if</span> ((rc=<a class="code" href="group__PJ__SOCK.htm#ga173d6da92ef0a4f0df062bf377b4d626">pj_sock_bind</a>(cs, &amp;srcaddr, <span class="keyword">sizeof</span>(srcaddr))) != 0) {
        app_perror(<span class="stringliteral">&quot;...bind error&quot;</span>, rc);
        rc = -121; <span class="keywordflow">goto</span> on_error;
    }
            
    <span class="comment">/* Test send/recv, with sendto */</span>
    rc = send_recv_test(<a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), ss, cs, &amp;dstaddr, NULL, 
                        <span class="keyword">sizeof</span>(dstaddr));
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">goto</span> on_error;

    <span class="comment">/* Test send/recv, with sendto and recvfrom */</span>
    rc = send_recv_test(<a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), ss, cs, &amp;dstaddr, 
                        &amp;srcaddr, <span class="keyword">sizeof</span>(dstaddr));
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">goto</span> on_error;

    <span class="comment">/* Disable this test on Symbian since UDP connect()/send() failed</span>
<span class="comment">     * with S60 3rd edition (including MR2).</span>
<span class="comment">     * See http://www.pjsip.org/trac/ticket/264</span>
<span class="comment">     */</span>    
<span class="preprocessor">#if !defined(PJ_SYMBIAN) || PJ_SYMBIAN==0</span>
<span class="preprocessor"></span>    <span class="comment">/* connect() the sockets. */</span>
    rc = <a class="code" href="group__PJ__SOCK.htm#gab351de456e475d5c50289a1cb079a8fe">pj_sock_connect</a>(cs, &amp;dstaddr, <span class="keyword">sizeof</span>(dstaddr));
    <span class="keywordflow">if</span> (rc != 0) {
        app_perror(<span class="stringliteral">&quot;...connect() error&quot;</span>, rc);
        rc = -122; <span class="keywordflow">goto</span> on_error;
    }

    <span class="comment">/* Test send/recv with send() */</span>
    rc = send_recv_test(<a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), ss, cs, NULL, NULL, 0);
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">goto</span> on_error;

    <span class="comment">/* Test send/recv with send() and recvfrom */</span>
    rc = send_recv_test(<a class="code" href="group__PJ__SOCK.htm#gaaa5fa1293ffc11d0970811819b3828dc">pj_SOCK_DGRAM</a>(), ss, cs, NULL, &amp;srcaddr, 
                        <span class="keyword">sizeof</span>(srcaddr));
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">goto</span> on_error;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
on_error:
    retval = rc;
    <span class="keywordflow">if</span> (cs != <a class="code" href="group__PJ__SOCK.htm#gab44152e660cc3fd044afd590eeea78bc">PJ_INVALID_SOCKET</a>) {
        rc = <a class="code" href="group__PJ__SOCK.htm#ga2f8faea76a64620b13a720227df927bb">pj_sock_close</a>(cs);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            app_perror(<span class="stringliteral">&quot;...error in closing socket&quot;</span>, rc);
            <span class="keywordflow">return</span> -1000;
        }
    }
    <span class="keywordflow">if</span> (ss != <a class="code" href="group__PJ__SOCK.htm#gab44152e660cc3fd044afd590eeea78bc">PJ_INVALID_SOCKET</a>) {
        rc = <a class="code" href="group__PJ__SOCK.htm#ga2f8faea76a64620b13a720227df927bb">pj_sock_close</a>(ss);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
            app_perror(<span class="stringliteral">&quot;...error in closing socket&quot;</span>, rc);
            <span class="keywordflow">return</span> -1010;
        }
    }

    <span class="keywordflow">return</span> retval;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> tcp_test(<span class="keywordtype">void</span>)
{
    <a class="code" href="group__PJ__BASIC.htm#ga5ccc87de27d1236bc31ae3673d153984">pj_sock_t</a> cs, ss;
    <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> rc = 0, retval;

    <a class="code" href="group__PJ__LOG.htm#ga767b9231bf7c2b57274771cdc4bca818">PJ_LOG</a>(3,(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;...tcp_test()&quot;</span>));

    rc = app_socketpair(<a class="code" href="group__PJ__SOCK.htm#ga8ea303b95fe973432a361e47e0459086">pj_AF_INET</a>(), <a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), 0, &amp;ss, &amp;cs);
    <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
        app_perror(<span class="stringliteral">&quot;...error: app_socketpair():&quot;</span>, rc);
        <span class="keywordflow">return</span> -2000;
    }

    <span class="comment">/* Test send/recv with send() and recv() */</span>
    retval = send_recv_test(<a class="code" href="group__PJ__SOCK.htm#gae224fbf8e8bd55b40030fcd8f9645291">pj_SOCK_STREAM</a>(), ss, cs, NULL, NULL, 0);

    rc = <a class="code" href="group__PJ__SOCK.htm#ga2f8faea76a64620b13a720227df927bb">pj_sock_close</a>(cs);
    <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
        app_perror(<span class="stringliteral">&quot;...error in closing socket&quot;</span>, rc);
        <span class="keywordflow">return</span> -2000;
    }

    rc = <a class="code" href="group__PJ__SOCK.htm#ga2f8faea76a64620b13a720227df927bb">pj_sock_close</a>(ss);
    <span class="keywordflow">if</span> (rc != <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>) {
        app_perror(<span class="stringliteral">&quot;...error in closing socket&quot;</span>, rc);
        <span class="keywordflow">return</span> -2010;
    }

    <span class="keywordflow">return</span> retval;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> ioctl_test(<span class="keywordtype">void</span>)
{
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> gethostbyname_test(<span class="keywordtype">void</span>)
{
    <a class="code" href="structpj__str__t.htm">pj_str_t</a> host;
    <a class="code" href="structpj__hostent.htm">pj_hostent</a> he;
    <a class="code" href="group__PJ__BASIC.htm#gab43ba3167bd2a2ab4580509dbf79200e">pj_status_t</a> status;

    <span class="comment">/* Testing pj_gethostbyname() with invalid host */</span>
    host = <a class="code" href="group__PJ__PSTR.htm#ga20fa0c4d9ccddd0822a775730cf4a867">pj_str</a>(<span class="stringliteral">&quot;an-invalid-host-name&quot;</span>);
    status = <a class="code" href="group__pj__addr__resolve.htm#ga7c8264aa7743594d31766679dbae0b88">pj_gethostbyname</a>(&amp;host, &amp;he);

    <span class="comment">/* Must return failure! */</span>
    <span class="keywordflow">if</span> (status == <a class="code" href="group__PJ__BASIC.htm#ga1a7d58698e362566cf64a0c59ab7d4cd">PJ_SUCCESS</a>)
        <span class="keywordflow">return</span> -20100;
    <span class="keywordflow">else</span>
        <span class="keywordflow">return</span> 0;
}

<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span><span class="preprocessor">#include &quot;../pj/os_symbian.h&quot;</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> connect_test()
{
        RSocketServ rSockServ;
        RSocket rSock;
        TInetAddr inetAddr;
        TRequestStatus reqStatus;
        <span class="keywordtype">char</span> buffer[16];
        TPtrC8 data((<span class="keyword">const</span> TUint8*)buffer, (TInt)<span class="keyword">sizeof</span>(buffer));
        <span class="keywordtype">int</span> rc;
        
        rc = rSockServ.Connect();
        <span class="keywordflow">if</span> (rc != KErrNone)
                <span class="keywordflow">return</span> rc;
        
        rc = rSock.Open(rSockServ, KAfInet, KSockDatagram, KProtocolInetUdp);
        <span class="keywordflow">if</span> (rc != KErrNone) 
        {               
                rSockServ.Close();
                <span class="keywordflow">return</span> rc;
        }
        
        inetAddr.Init(KAfInet);
        inetAddr.Input(_L(<span class="stringliteral">&quot;127.0.0.1&quot;</span>));
        inetAddr.SetPort(80);
        
        rSock.Connect(inetAddr, reqStatus);
        User::WaitForRequest(reqStatus);

        <span class="keywordflow">if</span> (reqStatus != KErrNone) {
                rSock.Close();
                rSockServ.Close();
                <span class="keywordflow">return</span> rc;
        }
    
        rSock.Send(data, 0, reqStatus);
        User::WaitForRequest(reqStatus);
        
        <span class="keywordflow">if</span> (reqStatus!=KErrNone) {
                rSock.Close();
                rSockServ.Close();
                <span class="keywordflow">return</span> rc;
        }
        
        rSock.Close();
        rSockServ.Close();
        <span class="keywordflow">return</span> KErrNone;
}
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="keywordtype">int</span> sock_test()
{
    <span class="keywordtype">int</span> rc;
    
    <a class="code" href="group__PJ__PSTR.htm#gae0f30eb53208168b12b6c8e50649ce89">pj_create_random_string</a>(bigdata, BIG_DATA_LEN);

<span class="comment">// Enable this to demonstrate the error witn S60 3rd Edition MR2</span>
<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span>    rc = connect_test();
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">return</span> rc;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    
    rc = format_test();
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">return</span> rc;

    rc = parse_test();
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">return</span> rc;

    rc = purity_test();
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">return</span> rc;

    rc = gethostbyname_test();
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">return</span> rc;

    rc = simple_sock_test();
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">return</span> rc;

    rc = ioctl_test();
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">return</span> rc;

    rc = udp_test();
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">return</span> rc;

    rc = tcp_test();
    <span class="keywordflow">if</span> (rc != 0)
        <span class="keywordflow">return</span> rc;

    <span class="keywordflow">return</span> 0;
}


<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="comment">/* To prevent warning about &quot;translation unit is empty&quot;</span>
<span class="comment"> * when this test is disabled. </span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> dummy_sock_test;
<span class="preprocessor">#endif  </span><span class="comment">/* INCLUDE_SOCK_TEST */</span>

</pre></div> </div>
<p>&nbsp;</p>
<hr><center>
PJLIB Open Source, high performance, small footprint, and very very portable framework<br>
Copyright (C) 2006-2009 Teluu Inc.
</center>


<!--#include virtual="/footer.html" -->

</BODY>
</HTML>
